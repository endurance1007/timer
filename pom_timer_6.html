<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro</title>
    <style>
        :root {
            /* ğŸŒ Light Mode Defaults */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --focus-color: #ff6b6b;
            --break-color: #4ecdc4;
            --skip-color: #a29bfe;
            --setting-color: #00b894;
            --text-color: #333;
            --gray-text: #666;
            --shadow: 0 4px 10px rgba(0,0,0,0.1);
            --black-bar: #333;
            --control-bg: #f8f9fa; 
            --input-border: #ddd;
        }
        
        /* ğŸŒ™ Dark Mode Variables */
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --focus-color: #ff8a8a; /* Brightened for contrast */
            --break-color: #80cbc4; /* Brightened for contrast */
            --skip-color: #c5baff;
            --setting-color: #69f0ae;
            --text-color: #e0e0e0;
            --gray-text: #b0b0b0;
            --shadow: 0 4px 10px rgba(0,0,0,0.5);
            --black-bar: #555;
            --control-bg: #2d2d2d;
            --input-border: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 10px 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        h1 { 
            margin-bottom: 10px; 
            font-weight: 800; 
            color: var(--focus-color); 
            font-size: 2.5rem;
        }

        /* --- Dashboard Layout --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1600px;
        }

        .session-card {
            background: var(--card-bg); 
            border-radius: 15px;
            padding: 15px; 
            box-shadow: var(--shadow); 
            display: flex;
            flex-direction: column;
            border-top: 6px solid var(--focus-color);
            position: relative;
            min-height: 450px; 
        }

        .session-name { 
            font-size: 1.1rem; 
            font-weight: bold; 
            border: none; 
            border-bottom: 1px solid var(--input-border); 
            width: 100%; 
            padding: 5px 0; 
            outline: none; 
            background: transparent; 
            color: var(--text-color); 
        }
        
        .session-note { 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            border: none; 
            border-bottom: 1px solid var(--input-border); 
            width: 100%; 
            padding: 5px 0; 
            margin-bottom: 5px; 
            outline: none;
            background: transparent; 
        }

        .status-badge { 
            text-align: center; 
            font-size: 0.85rem; 
            margin-bottom: 3px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            min-height: 1.2em; 
        }
        
        /* Cycle Visuals */
        .cycle-visuals { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: center; 
            gap: 5px; 
            margin: 5px 0 5px 0; /* ê¸°ë³¸ ë§ˆì§„ 5pxë¡œ ì¶•ì†Œ */
            font-size: 1.2rem; 
            min-height: 40px; 
            height: auto;
            align-content: flex-start;
            transition: margin-bottom 0.2s ease-in-out; 
        }
        
        .cycle-dot {
            text-shadow: 0 0 1px var(--black-bar), 0 0 1px var(--black-bar); 
        }
        .cycle-dot.completed { color: var(--gray-text); }
        .cycle-dot.current { color: var(--focus-color); animation: pulse 2s infinite; }
        .cycle-dot.future { color: #dfe6e9; } 
        body.dark-mode .cycle-dot.future { color: #3d3d3d; } 
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .timer-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* Total Planned Time Display */
        .total-time-display {
            font-size: 0.8rem; 
            color: var(--gray-text); 
            font-weight: 500;
            text-align: center;
            line-height: 1;
            padding-top: 5px;
        }
        
        /* Remaining Time Display (New) */
        .remaining-time-display {
            font-size: 0.8rem; 
            font-weight: bold;
            text-align: center;
            line-height: 1;
            margin-top: 3px; /* ì—¬ë°± ì¡°ì • */
            margin-bottom: -5px; /* íƒ€ì´ë¨¸ì™€ ê°€ê¹ê²Œ ë¶™ì´ê¸° */
            color: var(--focus-color); /* í¬ì»¤ìŠ¤ ìƒ‰ìƒìœ¼ë¡œ ê°•ì¡° */
        }
        .timer-display.break-mode + .remaining-time-display {
            color: var(--break-color); /* íœ´ì‹ ëª¨ë“œ ì‹œ ìƒ‰ìƒ ë³€ê²½ */
        }


        .timer-display { 
            font-size: 2.8rem; 
            font-weight: 800; 
            text-align: center; 
            margin: 0; 
            font-variant-numeric: tabular-nums; 
            color: var(--focus-color); 
            transition: color 0.3s; 
            line-height: 1.2;
        }
        .timer-display.break-mode { color: var(--break-color); }
        
        /* Progress Bar */
        .progress-container { 
            margin-bottom: 10px; 
            height: 6px; 
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-bg { 
            position: relative;
            width: 100%; 
            height: 6px; 
            background: var(--black-bar); 
            border-radius: 3px;
        }
        .progress-bar-fill { 
            height: 100%; 
            background: var(--focus-color); 
            width: 100%; 
            transition: width 1s linear, background-color 0.3s; 
            border-radius: 3px;
            transform-origin: right; 
        }

        /* Buttons */
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 6px; 
            margin-top: 5px; 
            margin-bottom: 10px; 
        }
        .full-width { grid-column: span 2; }
        button { 
            padding: 8px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            font-size: 0.9rem; 
        }
        button:hover { opacity: 0.9; }
        .btn-start { background-color: var(--focus-color); color: var(--card-bg); } 
        .btn-pause { background-color: #f1c40f; color: white; display: none; }
        .btn-pass { background-color: var(--skip-color); color: var(--card-bg); } 
        .btn-reset { background-color: #95a5a6; color: var(--card-bg); } 


        /* Controls */
        .controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 0px; 
            background: var(--control-bg); 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: auto; 
        }
        .control-group { 
            display: grid; 
            grid-template-columns: 1fr auto; 
            align-items: center; 
            gap: 8px; 
        }
        .control-group label { 
            grid-column: 1 / 2;
            font-size: 0.9rem; 
            color: var(--gray-text); 
            justify-self: start;
        }
        .control-group span { 
            grid-column: 2 / 3;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            width: 30px;
            text-align: right;
            color: var(--text-color); 
        }
        input[type=range] { 
            grid-column: 1 / 3;
            width: 100%; 
            cursor: pointer; 
            accent-color: var(--focus-color); 
            margin-top: 3px; 
        }
        input[type=range]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toggle-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            margin-top: 5px; 
            padding-top: 5px;
            border-top: 1px solid var(--input-border); 
        }
        
        /* Checkbox Switch Styling */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            cursor: pointer;
            width: 34px;
            height: 18px;
            border-radius: 10px;
            background: #ccc;
            transition: background 0.3s;
        }
        body.dark-mode input[type="checkbox"] {
            background: #666;
        }
        input[type="checkbox"]:checked {
            background: var(--setting-color);
        }
        input[type="checkbox"]::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s, background 0.3s;
        }
        input[type="checkbox"]:checked::after {
            transform: translateX(16px);
        }

        
        .alarm-selector { display: flex; gap: 5px; margin-top: 10px; }
        .alarm-selector button { 
            flex: 1; 
            font-size: 0.8rem; 
            padding: 6px; 
            border: 1px solid var(--gray-text); 
            background: var(--card-bg); 
            color: var(--text-color);
        }
        .alarm-selector button.selected { background: var(--setting-color); color: black; border-color: var(--setting-color); }
        body.dark-mode .alarm-selector button.selected { color: var(--card-bg); }
    </style>
</head>
<body>

    <h1>Pomodoro</h1>

    <div class="dashboard" id="dashboard">
    </div>

    <script>
        // --- Global State & Configuration ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeSessions = [];
        let globalVolume = 0.5;
        let alarmProfile = 'medium';
        let sessionCount = 5;
        let isDarkMode = false; 
        const defaultNames = ['ê¸°íš', 'ê°œë°œ', 'ë””ìì¸', 'ë¬¸ì„œí™”', 'íšŒì˜', 'í•™ìŠµ', 'ìš´ë™', 'ì •ë¦¬', 'ë…ì„œ', 'ê¸°íƒ€'];

        // ===================================
        // ğŸ’¾ LOCAL STORAGE FUNCTIONS
        // ===================================

        function saveGlobalSettings() {
            const settings = {
                sessionCount: sessionCount,
                globalVolume: globalVolume,
                alarmProfile: alarmProfile,
                isDarkMode: isDarkMode 
            };
            try {
                localStorage.setItem('pomodoroGlobalSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("Local storage error during global save:", e);
            }
        }

        function loadGlobalSettings() {
            try {
                const data = localStorage.getItem('pomodoroGlobalSettings');
                if (data) {
                    const settings = JSON.parse(data);
                    sessionCount = settings.sessionCount || 5;
                    globalVolume = settings.globalVolume !== undefined ? settings.globalVolume : 0.5;
                    alarmProfile = settings.alarmProfile || 'medium';
                    isDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false; 
                }
            } catch (e) {
                console.error("Local storage error during global load:", e);
            }
        }
        
        function saveSessionData() {
            const sessionData = activeSessions.map(session => ({
                id: session.id,
                name: session.name,
                note: session.note,
                focusTime: session.focusTime,
                breakTime: session.breakTime,
                totalCycles: session.totalCycles,
                autoAdvance: session.autoAdvance
            }));
            try {
                localStorage.setItem('pomodoroSessionData', JSON.stringify(sessionData));
            } catch (e) {
                console.error("Local storage error during session save:", e);
            }
        }

        function loadSessionData() {
            try {
                const data = localStorage.getItem('pomodoroSessionData');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Local storage error during session load:", e);
                return [];
            }
        }

        // ===================================
        // â²ï¸ TIME UTILITY FUNCTIONS
        // ===================================
        
        // ì´ ê³„íšëœ ì‹œê°„ í¬ë§· (ì…ë ¥: ë¶„)
        function formatTotalDuration(totalMinutes) {
            if (totalMinutes <= 0) {
                return 'ì´ 0ì‹œê°„ 00ë¶„';
            }
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (hours > 0) {
                return `ì´ ${hours}ì‹œê°„ ${String(minutes).padStart(2, '0')}ë¶„`;
            } else {
                return `ì´ ${String(minutes).padStart(2, '0')}ë¶„`;
            }
        }
        
        // ë‚¨ì€ ì‹œê°„ í¬ë§· (ì…ë ¥: ì´ˆ)
        function formatRemainingDuration(totalSeconds) {
            if (totalSeconds <= 0) return 'ì´ 0ì‹œê°„ 00ë¶„ ë‚¨ìŒ';
            
            // Math.ceilì„ ì‚¬ìš©í•˜ì—¬ ë‚¨ì€ ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼ (1ì´ˆë¼ë„ ë‚¨ìœ¼ë©´ 1ë¶„ ë‚¨ì€ ê²ƒìœ¼ë¡œ í‘œì‹œ)
            const totalMinutes = Math.ceil(totalSeconds / 60); 
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let timeStr = '';
            if (hours > 0) {
                timeStr = `${hours}ì‹œê°„ ${String(minutes).padStart(2, '0')}ë¶„`;
            } else {
                timeStr = `${String(minutes).padStart(2, '0')}ë¶„`;
            }
            
            return `ì´ ${timeStr} ë‚¨ìŒ`;
        }


        // ===================================
        // ğŸ”Š ALARM & DARK MODE FUNCTIONS
        // ===================================
        
        const createBeep = (startTime, duration, freq, type, vol) => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = type;
            oscillator.frequency.value = freq;
            gainNode.gain.setValueAtTime(vol, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        };
        
        function playNotificationSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            createBeep(now, 0.1, 440, 'sine', 0.15); 
        }

        function playAlarm() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const vol = Math.max(0.01, 1.0 * globalVolume);

            switch(alarmProfile) {
                case 'soft':
                    createBeep(now, 0.2, 440, 'sine', 0.2 * vol); 
                    break;
                case 'medium':
                    createBeep(now, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.15, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.3, 0.3, 1100, 'square', 0.5 * vol);
                    break;
                case 'loud':
                    createBeep(now, 0.5, 1200, 'sawtooth', 1.0 * vol); 
                    break;
            }
        }
        
        function toggleDarkMode(state) {
            if (state === undefined) {
                isDarkMode = !isDarkMode;
            } else {
                isDarkMode = state;
            }
            document.body.classList.toggle('dark-mode', isDarkMode);
            saveGlobalSettings();
        }

        // ===================================
        // â±ï¸ POMODORO SESSION CLASS
        // ===================================

        class PomodoroSession {
            constructor(id, defaultName, loadedData = {}) {
                this.id = id;
                this.name = loadedData.name || defaultName || `Session ${id}`;
                this.note = loadedData.note || '';
                this.state = 'stopped'; 
                this.mode = 'focus'; 
                this.currentCycle = 1;
                this.totalCycles = loadedData.totalCycles || 4;
                this.focusTime = loadedData.focusTime || 25; 
                this.breakTime = loadedData.breakTime || 5;  
                this.autoAdvance = loadedData.autoAdvance || false;
                
                this.timeLeft = this.focusTime * 60;
                this.timerInterval = null;
                this.initialTime = this.focusTime * 60;

                this.render();
                this.attachEvents();
                this.updateDisplay();
                this.renderCycles(); 
                this.updateTotalTimeDisplay(); 
                this.updateRemainingTimeDisplay(); // New: ì´ˆê¸° ë‚¨ì€ ì‹œê°„ í‘œì‹œ
            }
            
            calculateTotalTime() {
                const totalMinutes = (this.focusTime * this.totalCycles) + (this.breakTime * (this.totalCycles > 0 ? this.totalCycles - 1 : 0));
                return totalMinutes;
            }
            
            // New: ë‚¨ì€ ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ë¡œ ê³„ì‚°
            calculateRemainingTimeInSeconds() {
                let remainingTimeSeconds = 0;
                const F = this.focusTime * 60; // Focus in seconds
                const B = this.breakTime * 60; // Break in seconds
                const C_total = this.totalCycles;
                const C_current = this.currentCycle;

                if (C_current > C_total || this.state === 'finished') {
                    return 0; // ì„¸ì…˜ ì™„ë£Œ
                }

                // 1. í˜„ì¬ ë‹¨ê³„ì˜ ë‚¨ì€ ì‹œê°„ (ì´ˆ)
                remainingTimeSeconds += this.timeLeft;

                // 2. í˜„ì¬ ì‚¬ì´í´ì˜ ë‚¨ì€ ë‹¨ê³„ ì‹œê°„ (íœ´ì‹ ë‹¨ê³„ë§Œ ë‚¨ì•˜ì„ ê²½ìš°)
                if (this.mode === 'focus' && C_current < C_total) {
                    remainingTimeSeconds += B;
                }

                // 3. ë‚¨ì€ ì „ì²´ ì‚¬ì´í´ ì‹œê°„
                remainingTimeSeconds += (C_total - C_current) * (F + B);

                return remainingTimeSeconds;
            }


            updateTotalTimeDisplay() {
                const totalMinutes = this.calculateTotalTime(); 
                const formattedTime = formatTotalDuration(totalMinutes); // í•¨ìˆ˜ ì´ë¦„ ë³€ê²½ ë°˜ì˜
                
                const element = document.getElementById(`total-time-${this.id}`);
                if (element) {
                    element.innerText = formattedTime;
                }
                
                this.updateRemainingTimeDisplay(); // New: ì„¤ì • ë³€ê²½ ì‹œ ë‚¨ì€ ì‹œê°„ë„ ì—…ë°ì´íŠ¸
            }
            
            // New: ë‚¨ì€ ì‹œê°„ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
            updateRemainingTimeDisplay() {
                const remainingSeconds = this.calculateRemainingTimeInSeconds();
                const formattedTime = formatRemainingDuration(remainingSeconds);
                
                const element = document.getElementById(`remaining-time-${this.id}`);
                if (element) {
                    element.innerText = formattedTime;
                    
                    // ë‚¨ì€ ì‹œê°„ì´ 0ì´ê³ , íƒ€ì´ë¨¸ê°€ ë©ˆì¶°ìˆì„ ê²½ìš° ìˆ¨ê²¨ì„œ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬
                    if (remainingSeconds === 0 && this.state !== 'running') {
                         element.style.display = 'none';
                    } else {
                         element.style.display = 'block';
                    }
                    
                    // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
                    element.style.color = (this.mode === 'focus' ? 'var(--focus-color)' : 'var(--break-color)');
                }
            }


            render() {
                const container = document.getElementById('dashboard');
                const html = `
                    <div class="session-card" id="card-${this.id}">
                        <div class="card-header">
                            <input type="text" class="session-name" value="${this.name}">
                            <input type="text" class="session-note" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ (ì˜ˆ: ì§‘ì¤‘ ëª©í‘œ)" value="${this.note}">
                        </div>
                        
                        <div class="status-badge" id="status-${this.id}">Ready</div>
                        <div class="cycle-visuals" id="cycle-visuals-${this.id}"></div>
                        
                        <div class="timer-wrapper">
                            <div class="total-time-display" id="total-time-${this.id}"></div>
                            <div class="remaining-time-display" id="remaining-time-${this.id}"></div> 
                            
                            <div class="timer-display" id="timer-${this.id}">${(this.focusTime).toString().padStart(2, '0')}:00</div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progress-${this.id}"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-start full-width" id="btn-start-${this.id}">ì‹œì‘</button>
                            <button class="btn-pause full-width" id="btn-pause-${this.id}">ì¼ì‹œì •ì§€</button>
                            
                            <button class="btn-pass" id="btn-pass-${this.id}">PASS â­ï¸</button>
                            <button class="btn-reset" id="btn-reset-${this.id}">ë¦¬ì…‹ â†º</button>
                        </div>
                        
                        <div class="controls">
                            <div class="control-group">
                                <label>ì§‘ì¤‘ ì‹œê°„ (ë¶„)</label>
                                <span id="val-focus-${this.id}">${this.focusTime}</span>
                                <input type="range" id="input-focus-${this.id}" min="1" max="60" value="${this.focusTime}">
                            </div>
                            <div class="control-group">
                                <label>íœ´ì‹ ì‹œê°„ (ë¶„)</label>
                                <span id="val-break-${this.id}">${this.breakTime}</span>
                                <input type="range" id="input-break-${this.id}" min="1" max="10" value="${this.breakTime}">
                            </div>
                            <div class="control-group">
                                <label>ì´ ì‚¬ì´í´ ìˆ˜</label>
                                <span id="val-cycle-${this.id}">${this.totalCycles}</span>
                                <input type="range" id="input-cycle-${this.id}" min="1" max="20" value="${this.totalCycles}">
                            </div>
                            <div class="toggle-wrapper">
                                <span>ìë™ ì§„í–‰ (Auto Advance)</span>
                                <input type="checkbox" id="check-auto-${this.id}" ${this.autoAdvance ? 'checked' : ''}>
                            </div>
                        </div>

                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            
            attachEvents() {
                const updateAndSave = (callback) => (e) => {
                    callback(e);
                    
                    // ì„¤ì • ë³€ê²½ ì‹œ ì´ ì‹œê°„ ì—…ë°ì´íŠ¸
                    if (['input-focus', 'input-break', 'input-cycle'].some(idPart => e.target.id.includes(idPart))) {
                        this.updateTotalTimeDisplay(); 
                        playNotificationSound(); 
                    }
                    
                    // ì…‹íŒ… ì¡°ì • ì¤‘ì¼ ë•Œ íƒ€ì´ë¨¸ ì‹œê°„ ì¦‰ì‹œ ë°˜ì˜ ë° ì €ì¥
                    if (this.state === 'stopped' || this.state === 'paused' || e.type === 'change' || e.type === 'input') { 
                        saveSessionData();
                    }
                };
                
                document.getElementById(`card-${this.id}`).querySelector('.session-note').addEventListener('input', updateAndSave((e) => {
                    this.note = e.target.value;
                }));
                
                document.getElementById(`card-${this.id}`).querySelector('.session-name').addEventListener('input', updateAndSave((e) => {
                    this.name = e.target.value;
                }));
                
                document.getElementById(`input-focus-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.focusTime = parseInt(e.target.value);
                    document.getElementById(`val-focus-${this.id}`).innerText = this.focusTime;
                    
                    // ì •ì§€ ë˜ëŠ” ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œë§Œ í˜„ì¬ íƒ€ì´ë¨¸ ì‹œê°„ ì—…ë°ì´íŠ¸
                    if ((this.state === 'stopped' || this.state === 'paused') && this.mode === 'focus') {
                        this.timeLeft = this.focusTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateDisplay();
                    }
                }));
                
                document.getElementById(`input-break-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.breakTime = parseInt(e.target.value);
                    document.getElementById(`val-break-${this.id}`).innerText = this.breakTime;
                    
                    // ì •ì§€ ë˜ëŠ” ì¼ì‹œì •ì§€ ìƒíƒœì—ì„œë§Œ í˜„ì¬ íƒ€ì´ë¨¸ ì‹œê°„ ì—…ë°ì´íŠ¸
                    if ((this.state === 'stopped' || this.state === 'paused') && this.mode === 'break') {
                        this.timeLeft = this.breakTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateDisplay();
                    }
                }));
                
                document.getElementById(`input-cycle-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.totalCycles = parseInt(e.target.value);
                    document.getElementById(`val-cycle-${this.id}`).innerText = this.totalCycles;
                    this.renderCycles();
                    
                    // ì‚¬ì´í´ ìˆ˜ê°€ í˜„ì¬ ì§„í–‰ ì‚¬ì´í´ë³´ë‹¤ ì‘ì•„ì§€ë©´ ë¦¬ì…‹
                    if (this.currentCycle > this.totalCycles) {
                        this.resetTimer(); 
                    }
                }));
                
                document.getElementById(`check-auto-${this.id}`).addEventListener('change', updateAndSave((e) => {
                    this.autoAdvance = e.target.checked;
                }));

                // ë²„íŠ¼ ì´ë²¤íŠ¸ (ì•Œë¦¼ìŒ í¬í•¨)
                document.getElementById(`btn-start-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.start();
                });
                document.getElementById(`btn-pause-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.pause();
                });
                document.getElementById(`btn-reset-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.resetTimer();
                });
                document.getElementById(`btn-pass-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.skipPhase();
                });
            }

            
            renderCycles() {
                const container = document.getElementById(`cycle-visuals-${this.id}`);
                let html = '';
                const total = this.totalCycles;
                let firstRow, secondRow;

                // 1. ì‚¬ì´í´ ê°œìˆ˜ì— ë”°ë¥¸ ë§ˆì§„ ë™ì  ë³€ê²½ (ìš”ì²­ ì‚¬í•­ ë°˜ì˜)
                if (total <= 10) {
                    // í•œ ì¤„ì¼ ë•Œ: ë§ˆì§„ì„ 5pxë¡œ ì¤„ì—¬ ê³µê°„ 50% ì¶•ì†Œ (ê¸°ì¡´ 10pxì—ì„œ 5pxë¡œ)
                    container.style.marginBottom = '5px'; 
                    firstRow = total;
                    secondRow = 0;
                } else {
                    // ë‘ ì¤„ì¼ ë•Œ: ë§ˆì§„ì„ 15pxë¡œ ëŠ˜ë ¤ ë ˆì´ì•„ì›ƒ ì¹¨ë²” ë°©ì§€
                    container.style.marginBottom = '15px'; 
                    firstRow = 10;
                    secondRow = total - firstRow;
                }
                
                // 2. ì‚¬ì´í´ ì  ë Œë”ë§
                for (let i = 1; i <= total; i++) {
                    const isCurrent = i === this.currentCycle;
                    const isCompleted = i < this.currentCycle;
                    
                    if (i === firstRow + 1 && secondRow > 0) {
                         // ë‘ ë²ˆì§¸ ì¤„ ì‹œì‘ì 
                         html += '<div style="width: 100%; height: 0; margin-bottom: -5px;"></div>';
                    }

                    if (isCompleted) {
                        html += '<span class="cycle-dot completed">â—</span>'; 
                    } else if (isCurrent) {
                        html += `<span class="cycle-dot current">â—‰</span>`;
                    } else {
                        html += '<span class="cycle-dot future">â—‹</span>'; 
                    }
                }
                container.innerHTML = html;
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const display = document.getElementById(`timer-${this.id}`);
                
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = document.getElementById(`progress-${this.id}`);
                const percent = (this.timeLeft / this.initialTime) * 100;
                progress.style.width = `${percent}%`;

                const card = document.getElementById(`card-${this.id}`);
                if (this.mode === 'focus') {
                    display.classList.remove('break-mode');
                    progress.style.backgroundColor = 'var(--focus-color)';
                    card.style.borderTopColor = 'var(--focus-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--focus-color)');
                } else {
                    display.classList.add('break-mode');
                    progress.style.backgroundColor = 'var(--break-color)';
                    card.style.borderTopColor = 'var(--break-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--break-color)');
                }
                
                this.updateRemainingTimeDisplay(); // New: ë§¤ ì´ˆë§ˆë‹¤ ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
            }

            updateStatus(msg) {
                document.getElementById(`status-${this.id}`).innerText = msg;
            }

            start() {
                if (this.state === 'running') return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                this.state = 'running';
                document.getElementById(`btn-start-${this.id}`).style.display = 'none';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'block';
                this.toggleInputs(true); // ì‹¤í–‰ ì¤‘ì—ëŠ” ì„¤ì • ë¹„í™œì„±í™”
                this.updateStatus(this.mode === 'focus' ? 'ğŸ”¥ ì§‘ì¤‘ ì¤‘...' : 'â˜• íœ´ì‹ ì¤‘...');
                this.renderCycles();
                this.timerInterval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        this.updateDisplay();
                    } else {
                        this.completePhase();
                    }
                }, 1000);
            }

            pause() {
                if (this.state !== 'running') return;
                clearInterval(this.timerInterval);
                this.state = 'paused';
                document.getElementById(`btn-start-${this.id}`).innerText = 'ì¬ê°œ';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.toggleInputs(false); // New: ì¼ì‹œì •ì§€ ì¤‘ì—ëŠ” ì„¤ì • í™œì„±í™”
                this.updateStatus('â¸ï¸ ì¼ì‹œì •ì§€');
                saveSessionData();
            }

            skipPhase() {
                clearInterval(this.timerInterval);
                this.completePhase(true);
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.state = 'stopped';
                this.mode = 'focus';
                this.currentCycle = 1;
                this.timeLeft = this.focusTime * 60;
                this.initialTime = this.timeLeft;
                document.getElementById(`btn-start-${this.id}`).innerText = 'ì‹œì‘';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.toggleInputs(false);
                this.updateStatus('Ready');
                this.renderCycles();
                this.updateDisplay();
                this.updateRemainingTimeDisplay(); // New: ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
                saveSessionData();
            }

            completePhase(mute = false) {
                clearInterval(this.timerInterval);
                if (!mute) playAlarm(); 

                if (this.mode === 'focus') {
                    this.mode = 'break';
                    this.timeLeft = this.breakTime * 60;
                    this.initialTime = this.timeLeft;
                    this.updateStatus('â˜• íœ´ì‹ ì¤€ë¹„');
                } else {
                    if (this.currentCycle < this.totalCycles) {
                        this.mode = 'focus';
                        this.currentCycle++;
                        this.timeLeft = this.focusTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateStatus('ğŸ”¥ ì§‘ì¤‘ ì¤€ë¹„');
                    } else {
                        this.state = 'finished'; // New state for completion
                        this.resetTimer();
                        this.updateStatus('ğŸ‰ ì „ì²´ ì™„ë£Œ!');
                        if(!mute) playAlarm(); 
                        return;
                    }
                }
                this.renderCycles();
                this.updateDisplay();
                this.updateRemainingTimeDisplay(); // New: ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
                if (this.autoAdvance) {
                    this.state = 'stopped';
                    this.start();
                } else {
                    this.state = 'stopped';
                    document.getElementById(`btn-start-${this.id}`).innerText = 'ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘';
                    document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                    document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                    this.toggleInputs(false);
                }
            }

            toggleInputs(disabled) {
                document.getElementById(`input-focus-${this.id}`).disabled = disabled;
                document.getElementById(`input-break-${this.id}`).disabled = disabled;
                document.getElementById(`input-cycle-${this.id}`).disabled = disabled;
                document.getElementById(`check-auto-${this.id}`).disabled = disabled;
            }
        }


        // ===================================
        // âš™ï¸ GLOBAL CONTROLLER LOGIC
        // ===================================
        
        const getSettingsCardHTML = () => {
            const currentVolume = Math.round(globalVolume * 100);
            const softSelected = alarmProfile === 'soft' ? 'class="selected"' : '';
            const mediumSelected = alarmProfile === 'medium' ? 'class="selected"' : '';
            const loudSelected = alarmProfile === 'loud' ? 'class="selected"' : '';
            
            return `
                <div class="session-card" id="settings-card">
                    <div class="card-header">
                        <input type="text" class="session-name" value="Setting" disabled/>
                        <input type="text" class="session-note" id="setting-note-1" placeholder="ì„¤ì • ê´€ë ¨ ë©”ëª¨ (ì²« ë²ˆì§¸ ì¤„)" style="margin-bottom: 0px;">
                        <input type="text" class="session-note" id="setting-note-2" placeholder="ì„¤ì • ê´€ë ¨ ë©”ëª¨ (ë‘ ë²ˆì§¸ ì¤„)">
                    </div>
                    
                    <div class="status-badge" style="color: var(--setting-color);"></div> 
                    <div class="cycle-visuals" style="margin-bottom: 20px;"></div>

                    <div class="timer-wrapper">
                        <div class="total-time-display" style="font-size: 0.9rem; margin-top: 0;"></div>
                        <div class="remaining-time-display" style="font-size: 0.9rem; color: var(--setting-color); margin-bottom: 0px; margin-top: 5px;"></div>
                        <div class="timer-display" style="font-size: 2.5rem; color: var(--setting-color); margin-top: 5px;">âš™ï¸</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: 100%; background: #ddd;"></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons full-width" style="margin-top: 5px; margin-bottom: 10px;">
                        <button id="alarm-test" style="background-color: var(--setting-color); color: white;" class="full-width">í…ŒìŠ¤íŠ¸ ì•ŒëŒ ì¬ìƒ</button>
                    </div>

                    <div class="controls" style="gap: 15px; margin-top: auto; margin-bottom: 0;">
                        <div class="control-group">
                            <label>ìš´ì˜í•  íƒ€ì´ë¨¸ ê°œìˆ˜</label>
                            <span id="session-count-value">${sessionCount}</span>
                            <input type="range" id="session-count-slider" min="1" max="10" value="${sessionCount}">
                        </div>

                        <div class="control-group">
                            <label>ì•ŒëŒ ë³¼ë¥¨</label>
                            <span id="alarm-volume-value">${currentVolume}%</span>
                            <input type="range" id="alarm-volume-slider" min="0" max="100" value="${currentVolume}">
                        </div>
                        
                        <div style="grid-column: 1 / 3;">
                            <label style="font-size: 0.9rem; color: var(--gray-text);">ì•ŒëŒ ì¢…ë¥˜ ì„ íƒ</label>
                            <div class="alarm-selector">
                                <button id="alarm-soft" data-profile="soft" ${softSelected}>ì‘ì€ ì†Œë¦¬ ğŸ”ˆ</button>
                                <button id="alarm-medium" data-profile="medium" ${mediumSelected}>ì¤‘ê°„ ì†Œë¦¬ ğŸ””</button>
                                <button id="alarm-loud" data-profile="loud" ${loudSelected}>í° ì†Œë¦¬ ğŸ”Š</button>
                            </div>
                        </div>
                        
                        <div class="toggle-wrapper" style="margin-top: 15px;">
                            <span>ë‹¤í¬ ëª¨ë“œ</span>
                            <input type="checkbox" id="dark-mode-toggle" ${isDarkMode ? 'checked' : ''}>
                        </div>
                    </div>
                </div>
            `;
        };

        function attachGlobalListeners() {
            const countSlider = document.getElementById('session-count-slider');
            const countValue = document.getElementById('session-count-value');

            if (!countSlider) return; 

            countSlider.oninput = (e) => {
                countValue.innerText = e.target.value; 
            };
            
            countSlider.onchange = (e) => {
                sessionCount = parseInt(e.target.value);
                playNotificationSound(); 
                saveGlobalSettings(); 
                createSessions(); 
            }

            const volumeSlider = document.getElementById('alarm-volume-slider');
            const volumeValue = document.getElementById('alarm-volume-value');
            
            volumeSlider.oninput = (e) => {
                globalVolume = parseInt(e.target.value) / 100;
                volumeValue.innerText = `${e.target.value}%`;
                saveGlobalSettings(); 
            };
            
            document.querySelectorAll('#settings-card .alarm-selector button[data-profile]').forEach(button => {
                button.onclick = (e) => {
                    alarmProfile = e.target.dataset.profile;
                    playNotificationSound(); 
                    document.querySelectorAll('#settings-card .alarm-selector button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    saveGlobalSettings(); 
                };
            });
            
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                playNotificationSound();
                toggleDarkMode(e.target.checked);
            });

            document.getElementById('alarm-test').onclick = () => {
                playAlarm();
                playNotificationSound(); 
            }
        }

        function createSessions() {
            activeSessions.forEach(session => {
                clearInterval(session.timerInterval);
            });
            activeSessions = [];
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = ''; 

            const loadedSessions = loadSessionData();
            
            for(let i=1; i<=sessionCount; i++) {
                const loadedData = loadedSessions.find(s => s.id === i) || {};
                const name = defaultNames[i-1] || `ì„¸ì…˜ ${i}`;
                
                const newSession = new PomodoroSession(i, name, loadedData);
                activeSessions.push(newSession);
            }
            
            dashboard.insertAdjacentHTML('beforeend', getSettingsCardHTML());
            
            attachGlobalListeners(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalSettings(); 
            toggleDarkMode(isDarkMode); 
            
            if (audioCtx.state === 'suspended') {
                const resumeAudio = () => {
                    audioCtx.resume();
                    document.body.removeEventListener('touchstart', resumeAudio);
                    document.body.removeEventListener('mousedown', resumeAudio);
                };
                document.body.addEventListener('touchstart', resumeAudio, { once: true });
                document.body.addEventListener('mousedown', resumeAudio, { once: true });
            }
            createSessions(); 
        });

    </script>
</body>
</html>
