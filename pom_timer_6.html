<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro</title>
    <style>
        :root {
            /* üåû Light Mode Defaults */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --focus-color: #ff6b6b;
            --break-color: #4ecdc4;
            --skip-color: #a29bfe;
            --setting-color: #00b894;
            --text-color: #333;
            --gray-text: #666;
            --shadow: 0 4px 10px rgba(0,0,0,0.1);
            --black-bar: #333;
            --control-bg: #f8f9fa; 
            --input-border: #ddd;
        }
        
        /* üåô Dark Mode Variables */
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --focus-color: #ff8a8a; /* Brightened for contrast */
            --break-color: #80cbc4; /* Brightened for contrast */
            --skip-color: #c5baff;
            --setting-color: #69f0ae;
            --text-color: #e0e0e0;
            --gray-text: #b0b0b0;
            --shadow: 0 4px 10px rgba(0,0,0,0.5);
            --black-bar: #555;
            --control-bg: #2d2d2d;
            --input-border: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 10px 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        h1 { 
            margin-bottom: 10px; 
            font-weight: 800; 
            color: var(--focus-color); 
            font-size: 2.5rem;
        }

        /* --- Dashboard Layout --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1600px;
        }

        .session-card {
            background: var(--card-bg); 
            border-radius: 15px;
            padding: 15px; 
            box-shadow: var(--shadow); 
            display: flex;
            flex-direction: column;
            border-top: 6px solid var(--focus-color);
            position: relative;
            min-height: 450px; 
        }

        .session-name { 
            font-size: 1.1rem; 
            font-weight: bold; 
            border: none; 
            border-bottom: 1px solid var(--input-border); 
            width: 100%; 
            padding: 5px 0; 
            outline: none; 
            background: transparent; 
            color: var(--text-color); 
        }
        
        .session-note { 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            border: none; 
            border-bottom: 1px solid var(--input-border); 
            width: 100%; 
            padding: 5px 0; 
            margin-bottom: 5px; 
            outline: none;
            background: transparent; 
        }

        .status-badge { 
            text-align: center; 
            font-size: 0.85rem; 
            margin-bottom: 3px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            min-height: 1.2em; 
        }
        
        /* Cycle Visuals */
        .cycle-visuals { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: center; 
            gap: 5px; 
            margin: 5px 0 5px 0; /* Í∏∞Î≥∏ ÎßàÏßÑ 5pxÎ°ú Ï∂ïÏÜå */
            font-size: 1.2rem; 
            min-height: 40px; 
            height: auto;
            align-content: flex-start;
            transition: margin-bottom 0.2s ease-in-out; 
        }
        
        .cycle-dot {
            text-shadow: 0 0 1px var(--black-bar), 0 0 1px var(--black-bar); 
        }
        .cycle-dot.completed { color: var(--gray-text); }
        .cycle-dot.current { color: var(--focus-color); animation: pulse 2s infinite; }
        .cycle-dot.future { color: #dfe6e9; } 
        body.dark-mode .cycle-dot.future { color: #3d3d3d; } 
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .timer-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* Combined Time Summary Display */
        .time-summary-display { 
            font-size: 0.8rem; 
            color: var(--gray-text); /* ÏöîÏ≤≠Ïóê Îî∞Îùº ÏÉâÏÉÅ ÌÜµÏùº */
            font-weight: 500;
            text-align: center;
            line-height: 1;
            padding-top: 5px;
            margin-bottom: 5px; /* ÌÉÄÏù¥Î®∏ÏôÄ ÏïΩÍ∞ÑÏùò Í∞ÑÍ≤© */
            min-height: 1em; /* ÏΩòÌÖêÏ∏†Í∞Ä ÏóÜÏùÑ Îïå Î†àÏù¥ÏïÑÏõÉ Ï†êÌîÑ Î∞©ÏßÄ */
        }

        .timer-display { 
            font-size: 2.8rem; 
            font-weight: 800; 
            text-align: center; 
            margin: 0; 
            font-variant-numeric: tabular-nums; 
            color: var(--focus-color); 
            transition: color 0.3s; 
            line-height: 1.2;
        }
        .timer-display.break-mode { color: var(--break-color); }
        
        /* Progress Bar */
        .progress-container { 
            margin-bottom: 10px; 
            height: 6px; 
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-bg { 
            position: relative;
            width: 100%; 
            height: 6px; 
            background: var(--black-bar); 
            border-radius: 3px;
        }
        .progress-bar-fill { 
            height: 100%; 
            background: var(--focus-color); 
            width: 100%; 
            transition: width 1s linear, background-color 0.3s; 
            border-radius: 3px;
            transform-origin: right; 
        }

        /* Buttons */
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 6px; 
            margin-top: 5px; 
            margin-bottom: 10px; 
        }
        .full-width { grid-column: span 2; }
        button { 
            padding: 8px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            font-size: 0.9rem; 
        }
        button:hover { opacity: 0.9; }
        .btn-start { background-color: var(--focus-color); color: var(--card-bg); } 
        .btn-pause { background-color: #f1c40f; color: white; display: none; }
        .btn-pass { background-color: var(--skip-color); color: var(--card-bg); } 
        .btn-reset { background-color: #95a5a6; color: var(--card-bg); } 


        /* Controls */
        .controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 0px; 
            background: var(--control-bg); 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: auto; 
        }
        .control-group { 
            display: grid; 
            grid-template-columns: 1fr auto; 
            align-items: center; 
            gap: 8px; 
        }
        .control-group label { 
            grid-column: 1 / 2;
            font-size: 0.9rem; 
            color: var(--gray-text); 
            justify-self: start;
        }
        .control-group span { 
            grid-column: 2 / 3;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            width: 30px;
            text-align: right;
            color: var(--text-color); 
        }
        input[type=range] { 
            grid-column: 1 / 3;
            width: 100%; 
            cursor: pointer; 
            accent-color: var(--focus-color); 
            margin-top: 3px; 
        }
        input[type=range]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toggle-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            margin-top: 5px; 
            padding-top: 5px;
            border-top: 1px solid var(--input-border); 
        }
        
        /* Checkbox Switch Styling */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            cursor: pointer;
            width: 34px;
            height: 18px;
            border-radius: 10px;
            background: #ccc;
            transition: background 0.3s;
        }
        body.dark-mode input[type="checkbox"] {
            background: #666;
        }
        input[type="checkbox"]:checked {
            background: var(--setting-color);
        }
        input[type="checkbox"]::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s, background 0.3s;
        }
        input[type="checkbox"]:checked::after {
            transform: translateX(16px);
        }

        
        .alarm-selector { display: flex; gap: 5px; margin-top: 10px; }
        .alarm-selector button { 
            flex: 1; 
            font-size: 0.8rem; 
            padding: 6px; 
            border: 1px solid var(--gray-text); 
            background: var(--card-bg); 
            color: var(--text-color);
        }
        .alarm-selector button.selected { background: var(--setting-color); color: black; border-color: var(--setting-color); }
        body.dark-mode .alarm-selector button.selected { color: var(--card-bg); }
    </style>
</head>
<body>

    <h1>Pomodoro</h1>

    <div class="dashboard" id="dashboard">
    </div>

    <script>
        // --- Global State & Configuration ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeSessions = [];
        let globalVolume = 0.5;
        let alarmProfile = 'medium';
        let sessionCount = 5;
        let isDarkMode = false; 
        const defaultNames = ['Í∏∞Ìöç', 'Í∞úÎ∞ú', 'ÎîîÏûêÏù∏', 'Î¨∏ÏÑúÌôî', 'ÌöåÏùò', 'ÌïôÏäµ', 'Ïö¥Îèô', 'Ï†ïÎ¶¨', 'ÎèÖÏÑú', 'Í∏∞ÌÉÄ'];

        // ===================================
        // üíæ LOCAL STORAGE FUNCTIONS
        // ===================================

        function saveGlobalSettings() {
            const settings = {
                sessionCount: sessionCount,
                globalVolume: globalVolume,
                alarmProfile: alarmProfile,
                isDarkMode: isDarkMode 
            };
            try {
                localStorage.setItem('pomodoroGlobalSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("Local storage error during global save:", e);
            }
        }

        function loadGlobalSettings() {
            try {
                const data = localStorage.getItem('pomodoroGlobalSettings');
                if (data) {
                    const settings = JSON.parse(data);
                    sessionCount = settings.sessionCount || 5;
                    globalVolume = settings.globalVolume !== undefined ? settings.globalVolume : 0.5;
                    alarmProfile = settings.alarmProfile || 'medium';
                    isDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false; 
                }
            } catch (e) {
                console.error("Local storage error during global load:", e);
            }
        }
        
        function saveSessionData() {
            const sessionData = activeSessions.map(session => ({
                id: session.id,
                name: session.name,
                note: session.note,
                focusTime: session.focusTime,
                breakTime: session.breakTime,
                totalCycles: session.totalCycles,
                autoAdvance: session.autoAdvance
            }));
            try {
                localStorage.setItem('pomodoroSessionData', JSON.stringify(sessionData));
            } catch (e) {
                console.error("Local storage error during session save:", e);
            }
        }

        function loadSessionData() {
            try {
                const data = localStorage.getItem('pomodoroSessionData');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Local storage error during session load:", e);
                return [];
            }
        }

        // ===================================
        // ‚è≤Ô∏è TIME UTILITY FUNCTIONS
        // ===================================
        
        // Ï¥ù ÏãúÍ∞Ñ / ÎÇ®ÏùÄ ÏãúÍ∞ÑÏùÑ Ìè¨Îß∑ÌïòÎäî Îã®Ïùº Ìï®Ïàò (ÏûÖÎ†•: Î∂Ñ, Ï¥à)
        function formatTimeDisplay(totalMinutes, remainingSeconds) {
            
            // 1. Ï¥ù Í≥ÑÌöç ÏãúÍ∞Ñ Ìè¨Îß∑ (Î∂Ñ Îã®ÏúÑ ÏûÖÎ†•)
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            let totalTimeStr = 'Ï¥ù 0ÏãúÍ∞Ñ 00Î∂Ñ';
            if (totalMinutes > 0) {
                 if (hours > 0) {
                    totalTimeStr = `Ï¥ù ${hours}ÏãúÍ∞Ñ ${String(minutes).padStart(2, '0')}Î∂Ñ`;
                } else {
                    totalTimeStr = `Ï¥ù ${String(minutes).padStart(2, '0')}Î∂Ñ`;
                }
            }
            
            // 2. ÎÇ®ÏùÄ ÏãúÍ∞Ñ Ìè¨Îß∑ (Ï¥à Îã®ÏúÑ ÏûÖÎ†•, Î∂ÑÏúºÎ°ú Ïò¨Î¶º Ï≤òÎ¶¨)
            let remainingTimeStr = '';
            if (remainingSeconds > 0) {
                const remainingMinutes = Math.ceil(remainingSeconds / 60);
                const r_hours = Math.floor(remainingMinutes / 60);
                const r_minutes = remainingMinutes % 60;
                
                let timeStr = '';
                if (r_hours > 0) {
                    timeStr = `${r_hours}ÏãúÍ∞Ñ ${String(r_minutes).padStart(2, '0')}Î∂Ñ`;
                } else {
                    timeStr = `${String(r_minutes).padStart(2, '0')}Î∂Ñ`;
                }
                remainingTimeStr = `${timeStr} ÎÇ®Ïùå`;
            } else {
                remainingTimeStr = '0ÏãúÍ∞Ñ 00Î∂Ñ ÎÇ®Ïùå';
            }
            
            return `${totalTimeStr} | ${remainingTimeStr}`;
        }


        // ===================================
        // üîä ALARM & DARK MODE FUNCTIONS
        // ===================================
        
        const createBeep = (startTime, duration, freq, type, vol) => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = type;
            oscillator.frequency.value = freq;
            gainNode.gain.setValueAtTime(vol, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        };
        
        function playNotificationSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            createBeep(now, 0.1, 440, 'sine', 0.15); 
        }

        function playAlarm() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const vol = Math.max(0.01, 1.0 * globalVolume);

            switch(alarmProfile) {
                case 'soft':
                    createBeep(now, 0.2, 440, 'sine', 0.2 * vol); 
                    break;
                case 'medium':
                    createBeep(now, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.15, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.3, 0.3, 1100, 'square', 0.5 * vol);
                    break;
                case 'loud':
                    createBeep(now, 0.5, 1200, 'sawtooth', 1.0 * vol); 
                    break;
            }
        }
        
        function toggleDarkMode(state) {
            if (state === undefined) {
                isDarkMode = !isDarkMode;
            } else {
                isDarkMode = state;
            }
            document.body.classList.toggle('dark-mode', isDarkMode);
            saveGlobalSettings();
        }

        // ===================================
        // ‚è±Ô∏è POMODORO SESSION CLASS
        // ===================================

        class PomodoroSession {
            constructor(id, defaultName, loadedData = {}) {
                this.id = id;
                this.name = loadedData.name || defaultName || `Session ${id}`;
                this.note = loadedData.note || '';
                this.state = 'stopped'; 
                this.mode = 'focus'; 
                this.currentCycle = 1;
                this.totalCycles = loadedData.totalCycles || 4;
                this.focusTime = loadedData.focusTime || 25; 
                this.breakTime = loadedData.breakTime || 5;  
                this.autoAdvance = loadedData.autoAdvance || false;
                
                this.timeLeft = this.focusTime * 60;
                this.timerInterval = null;
                this.initialTime = this.focusTime * 60;

                this.render();
                this.attachEvents();
                this.updateDisplay();
                this.renderCycles(); 
                this.updateTimeSummaryDisplay(); // Ï¥ù ÏãúÍ∞Ñ/ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÌÜµÌï© ÏóÖÎç∞Ïù¥Ìä∏
            }
            
            // Ï¥ù Í≥ÑÌöç ÏãúÍ∞Ñ Í≥ÑÏÇ∞ (Î∂Ñ Îã®ÏúÑ) - ÌëúÏ§Ä Ìè¨Î™®ÎèÑÎ°ú: ÎßàÏßÄÎßâ Ìú¥ÏãùÏùÄ Ìè¨Ìï®ÌïòÏßÄ ÏïäÏùå
            calculateTotalTimeInMinutes() {
                const totalMinutes = (this.focusTime * this.totalCycles) + (this.breakTime * Math.max(0, this.totalCycles - 1));
                return totalMinutes;
            }
            
            // ÎÇ®ÏùÄ ÏãúÍ∞ÑÏùÑ Ï¥à Îã®ÏúÑÎ°ú Í≥ÑÏÇ∞ (Î°úÏßÅ ÏàòÏ†ï: Ï¥ù Í≥ÑÌöç ÏãúÍ∞ÑÍ≥º ÏùºÏπòÌïòÎèÑÎ°ù)
            calculateRemainingTimeInSeconds() {
                const F_sec = this.focusTime * 60; 
                const B_sec = this.breakTime * 60;
                const C_total = this.totalCycles;
                const C_current = this.currentCycle;

                if (C_current > C_total) { 
                    return 0; // ÏÑ∏ÏÖò ÏôÑÎ£å
                }
                
                let remaining = 0;
                
                // A. ÌòÑÏû¨ Îã®Í≥ÑÏùò ÎÇ®ÏùÄ ÏãúÍ∞Ñ (Ï¥à)
                remaining += this.timeLeft;
                
                // B. ÌòÑÏû¨ ÏÇ¨Ïù¥ÌÅ¥Ïùò ÎÇ®ÏùÄ Îã®Í≥Ñ ÏãúÍ∞Ñ (Ìú¥Ïãù)
                if (this.mode === 'focus' && C_current < C_total) {
                    remaining += B_sec; 
                }
                
                // C. ÎÇ®ÏùÄ Ï†ÑÏ≤¥ ÏÇ¨Ïù¥ÌÅ¥ (Focus + Break) ÏãúÍ∞Ñ
                let futureCycles = C_total - C_current;
                
                if (futureCycles > 0) {
                    // ÎÇ®ÏùÄ Ìè¨Ïª§Ïä§ ÏãúÍ∞Ñ: futureCycles Í∞ú (ÎßàÏßÄÎßâ ÏÇ¨Ïù¥ÌÅ¥ Ìè¨Ìï®)
                    remaining += futureCycles * F_sec;
                    
                    // ÎÇ®ÏùÄ Ìú¥Ïãù ÏãúÍ∞Ñ: futureCycles - 1 Í∞ú (ÎßàÏßÄÎßâ ÏÇ¨Ïù¥ÌÅ¥ Ïù¥ÌõÑ Ìú¥ÏãùÏùÄ Ï†úÏô∏)
                    remaining += Math.max(0, futureCycles - 1) * B_sec;
                }

                // Ï£ºÏùò: BÏôÄ CÏùò Î°úÏßÅÏùÄ AÏôÄ Ï§ëÎ≥µÎêòÏßÄ ÏïäÏïÑÏïº ÌïòÎ©∞,
                // BÍ∞Ä C_currentÏùò Î∏åÎ†àÏù¥ÌÅ¨Î•º Ï±ÖÏûÑÏßÄÍ≥†, CÎäî C_current Ïù¥ÌõÑÏùò Î™®Îì† F+BÎ•º Ï±ÖÏûÑÏßê.
                // ÏúÑ Î°úÏßÅÏùÄ BÍ∞Ä C_currentÏùò Î∏åÎ†àÏù¥ÌÅ¨Î•º, CÍ∞Ä C_current Ïù¥ÌõÑÏùò F+BÏåçÏùÑ Í≥ÑÏÇ∞ÌïòÎäî Î∞©ÏãùÏúºÎ°ú Ï†ïÌï©ÏÑ±ÏùÑ ÌôïÎ≥¥Ìï®.

                return remaining;
            }


            // Ï¥ù ÏãúÍ∞Ñ Î∞è ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÌÜµÌï©)
            updateTimeSummaryDisplay() {
                const totalMinutes = this.calculateTotalTimeInMinutes(); 
                const remainingSeconds = this.calculateRemainingTimeInSeconds();
                const formattedTime = formatTimeDisplay(totalMinutes, remainingSeconds);
                
                const element = document.getElementById(`time-summary-${this.id}`);
                if (element) {
                    element.innerText = formattedTime;
                    
                    // ÏÑ∏ÏÖò ÏôÑÎ£å Ïãú Ïà®ÍπÄ Ï≤òÎ¶¨
                    if (totalMinutes === 0 || remainingSeconds === 0 && this.state !== 'running') {
                        // totalMinutesÍ∞Ä 0Ïù¥Î©¥ ÏÑ§Ï†ïÏù¥ 0Ïù¥ÎùºÎäî ÏùòÎØ∏Ïù¥ÎØÄÎ°ú Ìï≠ÏÉÅ Î≥¥ÏûÑ
                        if (remainingSeconds === 0 && this.state !== 'running' && totalMinutes > 0) {
                            element.innerText = `Ï¥ù ${formatTimeDisplay(totalMinutes, 0)}`;
                        }
                    }
                }
            }


            render() {
                const container = document.getElementById('dashboard');
                const html = `
                    <div class="session-card" id="card-${this.id}">
                        <div class="card-header">
                            <input type="text" class="session-name" value="${this.name}">
                            <input type="text" class="session-note" placeholder="Í∞ÑÎã®Ìïú Î©îÎ™® (Ïòà: ÏßëÏ§ë Î™©Ìëú)" value="${this.note}">
                        </div>
                        
                        <div class="status-badge" id="status-${this.id}">Ready</div>
                        <div class="cycle-visuals" id="cycle-visuals-${this.id}"></div>
                        
                        <div class="timer-wrapper">
                            <div class="time-summary-display" id="time-summary-${this.id}"></div>
                            
                            <div class="timer-display" id="timer-${this.id}">${(this.focusTime).toString().padStart(2, '0')}:00</div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progress-${this.id}"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-start full-width" id="btn-start-${this.id}">ÏãúÏûë</button>
                            <button class="btn-pause full-width" id="btn-pause-${this.id}">ÏùºÏãúÏ†ïÏßÄ</button>
                            
                            <button class="btn-pass" id="btn-pass-${this.id}">PASS ‚è≠Ô∏è</button>
                            <button class="btn-reset" id="btn-reset-${this.id}">Î¶¨ÏÖã ‚Ü∫</button>
                        </div>
                        
                        <div class="controls">
                            <div class="control-group">
                                <label>ÏßëÏ§ë ÏãúÍ∞Ñ (Î∂Ñ)</label>
                                <span id="val-focus-${this.id}">${this.focusTime}</span>
                                <input type="range" id="input-focus-${this.id}" min="1" max="60" value="${this.focusTime}">
                            </div>
                            <div class="control-group">
                                <label>Ìú¥Ïãù ÏãúÍ∞Ñ (Î∂Ñ)</label>
                                <span id="val-break-${this.id}">${this.breakTime}</span>
                                <input type="range" id="input-break-${this.id}" min="1" max="10" value="${this.breakTime}">
                            </div>
                            <div class="control-group">
                                <label>Ï¥ù ÏÇ¨Ïù¥ÌÅ¥ Ïàò</label>
                                <span id="val-cycle-${this.id}">${this.totalCycles}</span>
                                <input type="range" id="input-cycle-${this.id}" min="1" max="20" value="${this.totalCycles}">
                            </div>
                            <div class="toggle-wrapper">
                                <span>ÏûêÎèô ÏßÑÌñâ (Auto Advance)</span>
                                <input type="checkbox" id="check-auto-${this.id}" ${this.autoAdvance ? 'checked' : ''}>
                            </div>
                        </div>

                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            
            attachEvents() {
                const updateAndSave = (callback) => (e) => {
                    callback(e);
                    
                    // ÏÑ§Ï†ï Î≥ÄÍ≤Ω Ïãú Ï¥ù ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    if (['input-focus', 'input-break', 'input-cycle'].some(idPart => e.target.id.includes(idPart))) {
                        this.updateTimeSummaryDisplay(); 
                        playNotificationSound(); 
                    }
                    
                    // ÏÖãÌåÖ Ï°∞Ï†ï Ï§ëÏùº Îïå ÌÉÄÏù¥Î®∏ ÏãúÍ∞Ñ Ï¶âÏãú Î∞òÏòÅ Î∞è Ï†ÄÏû•
                    if (this.state === 'stopped' || this.state === 'paused' || e.type === 'change' || e.type === 'input') { 
                        saveSessionData();
                    }
                };
                
                document.getElementById(`card-${this.id}`).querySelector('.session-note').addEventListener('input', updateAndSave((e) => {
                    this.note = e.target.value;
                }));
                
                document.getElementById(`card-${this.id}`).querySelector('.session-name').addEventListener('input', updateAndSave((e) => {
                    this.name = e.target.value;
                }));
                
                document.getElementById(`input-focus-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.focusTime = parseInt(e.target.value);
                    document.getElementById(`val-focus-${this.id}`).innerText = this.focusTime;
                    
                    // Ï†ïÏßÄ ÎòêÎäî ÏùºÏãúÏ†ïÏßÄ ÏÉÅÌÉúÏóêÏÑúÎßå ÌòÑÏû¨ ÌÉÄÏù¥Î®∏ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    if ((this.state === 'stopped' || this.state === 'paused') && this.mode === 'focus') {
                        this.timeLeft = this.focusTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateDisplay();
                    }
                }));
                
                document.getElementById(`input-break-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.breakTime = parseInt(e.target.value);
                    document.getElementById(`val-break-${this.id}`).innerText = this.breakTime;
                    
                    // Ï†ïÏßÄ ÎòêÎäî ÏùºÏãúÏ†ïÏßÄ ÏÉÅÌÉúÏóêÏÑúÎßå ÌòÑÏû¨ ÌÉÄÏù¥Î®∏ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    if ((this.state === 'stopped' || this.state === 'paused') && this.mode === 'break') {
                        this.timeLeft = this.breakTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateDisplay();
                    }
                }));
                
                document.getElementById(`input-cycle-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.totalCycles = parseInt(e.target.value);
                    document.getElementById(`val-cycle-${this.id}`).innerText = this.totalCycles;
                    this.renderCycles();
                    
                    // ÏÇ¨Ïù¥ÌÅ¥ ÏàòÍ∞Ä ÌòÑÏû¨ ÏßÑÌñâ ÏÇ¨Ïù¥ÌÅ¥Î≥¥Îã§ ÏûëÏïÑÏßÄÎ©¥ Î¶¨ÏÖã
                    if (this.currentCycle > this.totalCycles) {
                        this.resetTimer(); 
                    }
                }));
                
                document.getElementById(`check-auto-${this.id}`).addEventListener('change', updateAndSave((e) => {
                    this.autoAdvance = e.target.checked;
                }));

                // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (ÏïåÎ¶ºÏùå Ìè¨Ìï®)
                document.getElementById(`btn-start-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.start();
                });
                document.getElementById(`btn-pause-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.pause();
                });
                document.getElementById(`btn-reset-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.resetTimer();
                });
                document.getElementById(`btn-pass-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.skipPhase();
                });
            }

            
            renderCycles() {
                const container = document.getElementById(`cycle-visuals-${this.id}`);
                let html = '';
                const total = this.totalCycles;
                let firstRow, secondRow;

                // 1. ÏÇ¨Ïù¥ÌÅ¥ Í∞úÏàòÏóê Îî∞Î•∏ ÎßàÏßÑ ÎèôÏ†Å Î≥ÄÍ≤Ω (ÏöîÏ≤≠ ÏÇ¨Ìï≠ Î∞òÏòÅ)
                if (total <= 10) {
                    // Ìïú Ï§ÑÏùº Îïå: ÎßàÏßÑÏùÑ 5pxÎ°ú Ï§ÑÏó¨ Í≥µÍ∞Ñ 50% Ï∂ïÏÜå (Í∏∞Ï°¥ 10pxÏóêÏÑú 5pxÎ°ú)
                    container.style.marginBottom = '5px'; 
                    firstRow = total;
                    secondRow = 0;
                } else {
                    // Îëê Ï§ÑÏùº Îïå: ÎßàÏßÑÏùÑ 15pxÎ°ú ÎäòÎ†§ Î†àÏù¥ÏïÑÏõÉ Ïπ®Î≤î Î∞©ÏßÄ
                    container.style.marginBottom = '15px'; 
                    firstRow = 10;
                    secondRow = total - firstRow;
                }
                
                // 2. ÏÇ¨Ïù¥ÌÅ¥ Ï†ê Î†åÎçîÎßÅ
                for (let i = 1; i <= total; i++) {
                    const isCurrent = i === this.currentCycle;
                    const isCompleted = i < this.currentCycle;
                    
                    if (i === firstRow + 1 && secondRow > 0) {
                         // Îëê Î≤àÏß∏ Ï§Ñ ÏãúÏûëÏ†ê
                         html += '<div style="width: 100%; height: 0; margin-bottom: -5px;"></div>';
                    }

                    if (isCompleted) {
                        html += '<span class="cycle-dot completed">‚óè</span>'; 
                    } else if (isCurrent) {
                        html += `<span class="cycle-dot current">‚óâ</span>`;
                    } else {
                        html += '<span class="cycle-dot future">‚óã</span>'; 
                    }
                }
                container.innerHTML = html;
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const display = document.getElementById(`timer-${this.id}`);
                
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = document.getElementById(`progress-${this.id}`);
                const percent = (this.timeLeft / this.initialTime) * 100;
                progress.style.width = `${percent}%`;

                const card = document.getElementById(`card-${this.id}`);
                
                // ÏÉâÏÉÅ ÏóÖÎç∞Ïù¥Ìä∏: Ìè¨Ïª§Ïä§/Î∏åÎ†àÏù¥ÌÅ¨Ïóê Îî∞Îùº ÌÉÄÏù¥Î®∏ ÏÉâÏÉÅ Î∞è ÌîÑÎ°úÍ∑∏Î†àÏä§Î∞î, Ïπ¥Îìú Î≥¥Îçî ÏÉâÏÉÅ Î≥ÄÍ≤Ω
                if (this.mode === 'focus') {
                    display.classList.remove('break-mode');
                    progress.style.backgroundColor = 'var(--focus-color)';
                    card.style.borderTopColor = 'var(--focus-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--focus-color)');
                } else {
                    display.classList.add('break-mode');
                    progress.style.backgroundColor = 'var(--break-color)';
                    card.style.borderTopColor = 'var(--break-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--break-color)');
                }
                
                this.updateTimeSummaryDisplay(); // Îß§ Ï¥àÎßàÎã§ ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
            }

            updateStatus(msg) {
                document.getElementById(`status-${this.id}`).innerText = msg;
            }

            start() {
                if (this.state === 'running') return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                this.state = 'running';
                document.getElementById(`btn-start-${this.id}`).style.display = 'none';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'block';
                this.toggleInputs(true); // Ïã§Ìñâ Ï§ëÏóêÎäî ÏÑ§Ï†ï
