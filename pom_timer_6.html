<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro</title>
    <style>
        :root {
            /* üåû Light Mode Defaults */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --focus-color: #ff6b6b;
            --break-color: #4ecdc4;
            --skip-color: #a29bfe;
            --setting-color: #00b894;
            --text-color: #333;
            --gray-text: #666;
            --shadow: 0 4px 10px rgba(0,0,0,0.1);
            --black-bar: #333;
            --control-bg: #f8f9fa; /* Ïª®Ìä∏Î°§ ÏòÅÏó≠ Î∞∞Í≤Ω */
            --input-border: #ddd;
        }
        
        /* üåô Dark Mode Variables */
        body.dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --focus-color: #ff8a8a; /* Brightened for contrast */
            --break-color: #80cbc4; /* Brightened for contrast */
            --skip-color: #c5baff;
            --setting-color: #69f0ae;
            --text-color: #e0e0e0;
            --gray-text: #b0b0b0;
            --shadow: 0 4px 10px rgba(0,0,0,0.5);
            --black-bar: #555;
            --control-bg: #2d2d2d;
            --input-border: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0;
            padding: 20px 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        h1 { 
            margin-bottom: 20px; 
            font-weight: 800; 
            color: var(--focus-color); 
            font-size: 2.5rem;
        }

        /* --- Dashboard Layout --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1600px;
        }

        /* --- Session Card Styling --- */
        .session-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            border-top: 6px solid var(--focus-color);
            position: relative;
        }

        .session-name { 
            font-size: 1.1rem; 
            font-weight: bold; 
            border: none; 
            border-bottom: 1px solid var(--input-border); 
            width: 100%; 
            padding: 5px 0; 
            outline: none; 
            background: transparent;
            color: var(--text-color); 
        }

        .session-note { 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            border: none; 
            border-bottom: 1px solid var(--input-border);
            width: 100%; 
            padding: 5px 0; 
            margin-bottom: 10px;
            outline: none;
            background: transparent;
        }
        
        /* Note Wrapper Styling for Global Settings Card */
        .notes-wrapper {
            padding: 15px;
            background: var(--control-bg); 
            border-radius: 8px; 
            margin-bottom: 10px; /* Ïï°ÏÖò Î≤ÑÌäºÍ≥ºÏùò Í∞ÑÍ≤© */
        }
        .notes-wrapper .session-note {
             margin-bottom: 5px; /* ÎÇ¥Î∂Ä Í∞ÑÍ≤© Ï§ÑÏûÑ */
        }
        .notes-wrapper .session-note:last-child {
             margin-bottom: 0; 
        }

        /* --- Cycle Visuals --- */
        .cycle-visuals { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: center; 
            gap: 5px; 
            margin: 10px 0; 
            font-size: 1.2rem; 
            height: 35px;
            align-content: flex-start;
        }
        
        .cycle-dot {
            text-shadow: 0 0 1px var(--black-bar), 0 0 1px var(--black-bar); 
        }
        .cycle-dot.completed { color: var(--gray-text); }
        .cycle-dot.current { color: var(--focus-color); animation: pulse 2s infinite; }
        .cycle-dot.future { color: #dfe6e9; } 
        body.dark-mode .cycle-dot.future { color: #3d3d3d; }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* --- Timer & Progress Bar --- */
        .timer-display { 
            font-size: 3.2rem; 
            font-weight: 800; 
            text-align: center; 
            margin: 10px 0 0 0; 
            font-variant-numeric: tabular-nums; 
            color: var(--focus-color); 
            transition: color 0.3s; 
        }
        .timer-display.break-mode { color: var(--break-color); }
        .status-badge { text-align: center; font-size: 0.85rem; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; min-height: 1.2em; }
        
        .progress-container { 
            margin-bottom: 20px;
            height: 6px; 
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-bg { 
            position: relative;
            width: 100%; 
            height: 6px; 
            background: var(--black-bar);
            border-radius: 3px;
        }
        .progress-bar-fill { 
            height: 100%; 
            background: var(--focus-color); 
            width: 100%; 
            transition: width 1s linear, background-color 0.3s; 
            border-radius: 3px;
            transform-origin: right; 
        }

        /* --- Controls --- */
        .controls { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            margin-bottom: 20px; 
            background: var(--control-bg); 
            padding: 15px;
            border-radius: 8px; 
        }
        .control-group { 
            display: grid; 
            grid-template-columns: 1fr auto; 
            align-items: center; 
            gap: 10px;
        }
        .control-group label { 
            grid-column: 1 / 2;
            font-size: 0.9rem; 
            color: var(--gray-text); 
            justify-self: start;
        }
        .control-group span { 
            grid-column: 2 / 3;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            width: 30px;
            text-align: right;
            color: var(--text-color);
        }
        input[type=range] { 
            grid-column: 1 / 3;
            width: 100%; 
            cursor: pointer; 
            accent-color: var(--focus-color); 
            margin-top: 5px;
        }
        
        .toggle-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            margin-top: 5px; 
            padding-top: 5px;
            border-top: 1px solid var(--input-border);
        }

        /* Checkbox Switch Styling */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
            cursor: pointer;
            width: 34px;
            height: 18px;
            border-radius: 10px;
            background: #ccc;
            transition: background 0.3s;
        }
        body.dark-mode input[type="checkbox"] {
            background: #666;
        }
        input[type="checkbox"]:checked {
            /* ON ÏÉÅÌÉúÏùº Îïå Î∞ùÏùÄ ÎÖπÏÉâÏúºÎ°ú 'Î∂àÏù¥ Îì§Ïñ¥Ïò®' Ìö®Í≥º */
            background: var(--setting-color); 
        }
        input[type="checkbox"]::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s, background 0.3s;
        }
        input[type="checkbox"]:checked::after {
            transform: translateX(16px);
        }
        
        /* Ïù¥Ï†Ñ ÏöîÏ≤≠ÏóêÏÑú ÏÇ¨Ïö©Îêú ÌÖçÏä§Ìä∏ Í∞ïÏ°∞ CSSÎäî Ï†úÍ±∞ÌïòÏó¨ ÌÜ†Í∏Ä ÏûêÏ≤¥Ïùò ÏÉâÏÉÅ Î≥ÄÌôîÏóê ÏßëÏ§ëÌï® */

        /* --- Buttons --- */
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            margin-top: 20px; 
        }
        .full-width { grid-column: span 2; }
        button { padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; font-size: 0.9rem; }
        button:hover { opacity: 0.9; }
        .btn-start { background-color: var(--focus-color); color: white; }
        .btn-pause { background-color: #f1c40f; color: white; display: none; }
        .btn-pass { background-color: var(--skip-color); color: white; }
        .btn-reset { background-color: #95a5a6; color: white; }
        
        .alarm-selector { display: flex; gap: 5px; margin-top: 10px; }
        .alarm-selector button { flex: 1; font-size: 0.8rem; padding: 6px; border: 1px solid var(--input-border); background: var(--card-bg); color: var(--text-color); }
        .alarm-selector button.selected { background: var(--setting-color); color: white; border-color: var(--setting-color); }
    </style>
</head>
<body>

    <h1>Pomodoro</h1>

    <div class="dashboard" id="dashboard">
    </div>

    <script>
        // --- Global State & Configuration ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeSessions = [];
        let globalVolume = 0.5;
        let alarmProfile = 'medium';
        let sessionCount = 5;
        let isDarkMode = false; 
        let settingNote1 = '';
        let settingNote2 = '';
        let settingNote3 = '';
        let settingNote4 = '';
        
        const defaultNames = ['Í∏∞Ìöç', 'Í∞úÎ∞ú', 'ÎîîÏûêÏù∏', 'Î¨∏ÏÑúÌôî', 'ÌöåÏùò', 'ÌïôÏäµ', 'Ïö¥Îèô', 'Ï†ïÎ¶¨', 'ÎèÖÏÑú', 'Í∏∞ÌÉÄ'];

        // ===================================
        // üíæ LOCAL STORAGE FUNCTIONS
        // ===================================

        function saveGlobalSettings() {
            const settings = {
                sessionCount: sessionCount,
                globalVolume: globalVolume,
                alarmProfile: alarmProfile,
                isDarkMode: isDarkMode, 
                settingNote1: settingNote1,
                settingNote2: settingNote2,
                settingNote3: settingNote3,
                settingNote4: settingNote4
            };
            try {
                localStorage.setItem('pomodoroGlobalSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("Local storage error during global save:", e);
            }
        }

        function loadGlobalSettings() {
            try {
                const data = localStorage.getItem('pomodoroGlobalSettings');
                if (data) {
                    const settings = JSON.parse(data);
                    sessionCount = settings.sessionCount || 5;
                    globalVolume = settings.globalVolume !== undefined ? settings.globalVolume : 0.5;
                    alarmProfile = settings.alarmProfile || 'medium';
                    isDarkMode = settings.isDarkMode !== undefined ? settings.isDarkMode : false; 
                    settingNote1 = settings.settingNote1 || '';
                    settingNote2 = settings.settingNote2 || '';
                    settingNote3 = settings.settingNote3 || '';
                    settingNote4 = settings.settingNote4 || '';
                }
            } catch (e) {
                console.error("Local storage error during global load:", e);
            }
        }

        function saveSessionData() {
            const sessionData = activeSessions.map(session => ({
                id: session.id,
                name: session.name,
                note: session.note,
                focusTime: session.focusTime,
                breakTime: session.breakTime,
                totalCycles: session.totalCycles,
                autoAdvance: session.autoAdvance
            }));
            try {
                localStorage.setItem('pomodoroSessionData', JSON.stringify(sessionData));
            } catch (e) {
                console.error("Local storage error during session save:", e);
            }
        }

        function loadSessionData() {
            try {
                const data = localStorage.getItem('pomodoroSessionData');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Local storage error during session load:", e);
                return [];
            }
        }

        // ===================================
        // üîä ALARM & DARK MODE FUNCTIONS
        // ===================================
        
        function playAlarm() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            const createBeep = (startTime, duration, freq, type, vol) => {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = type;
                oscillator.frequency.value = freq;
                const effectiveVolume = Math.max(0.01, vol * globalVolume);
                gainNode.gain.setValueAtTime(effectiveVolume, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
            };

            switch(alarmProfile) {
                case 'soft':
                    createBeep(now, 0.2, 440, 'sine', 0.2); 
                    break;
                case 'medium':
                    createBeep(now, 0.1, 880, 'square', 0.5);
                    createBeep(now + 0.15, 0.1, 880, 'square', 0.5);
                    createBeep(now + 0.3, 0.3, 1100, 'square', 0.5);
                    break;
                case 'loud':
                    createBeep(now, 0.5, 1200, 'sawtooth', 1.0); 
                    break;
            }
        }
        
        function toggleDarkMode(state) {
            if (state === undefined) {
                isDarkMode = !isDarkMode;
            } else {
                isDarkMode = state;
            }
            document.body.classList.toggle('dark-mode', isDarkMode);
            saveGlobalSettings();
        }

        // ===================================
        // ‚è±Ô∏è POMODORO SESSION CLASS
        // ===================================

        class PomodoroSession {
            constructor(id, defaultName, loadedData = {}) {
                this.id = id;
                this.name = loadedData.name || defaultName || `Session ${id}`;
                this.note = loadedData.note || '';
                this.state = 'stopped'; 
                this.mode = 'focus'; 
                this.currentCycle = 1;
                this.totalCycles = loadedData.totalCycles || 4;
                this.focusTime = loadedData.focusTime || 25; 
                this.breakTime = loadedData.breakTime || 5;  
                this.autoAdvance = loadedData.autoAdvance || false;
                
                this.timeLeft = this.focusTime * 60;
                this.timerInterval = null;
                this.initialTime = this.focusTime * 60;

                this.render();
                this.attachEvents();
                this.updateDisplay();
                this.renderCycles(); 
            }

            render() {
                const container = document.getElementById('dashboard');
                const html = `
                    <div class="session-card" id="card-${this.id}">
                        <div class="card-header">
                            <input type="text" class="session-name" value="${this.name}">
                            <input type="text" class="session-note" placeholder="Î©îÎ™®" value="${this.note}">
                        </div>
                        
                        <div class="status-badge" id="status-${this.id}">Ready</div>
                        <div class="cycle-visuals" id="cycle-visuals-${this.id}"></div>
                        
                        <div class="timer-display" id="timer-${this.id}">${(this.focusTime).toString().padStart(2, '0')}:00</div>
                        
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progress-${this.id}"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-start full-width" id="btn-start-${this.id}">ÏãúÏûë</button>
                            <button class="btn-pause full-width" id="btn-pause-${this.id}">ÏùºÏãúÏ†ïÏßÄ</button>
                            
                            <button class="btn-pass" id="btn-pass-${this.id}">PASS ‚è≠Ô∏è</button>
                            <button class="btn-reset" id="btn-reset-${this.id}">Î¶¨ÏÖã ‚Ü∫</button>
                        </div>

                        <div class="controls">
                            <div class="control-group">
                                <label>ÏßëÏ§ë ÏãúÍ∞Ñ (Î∂Ñ)</label>
                                <span id="val-focus-${this.id}">${this.focusTime}</span>
                                <input type="range" id="input-focus-${this.id}" min="1" max="60" value="${this.focusTime}">
                            </div>
                            <div class="control-group">
                                <label>Ìú¥Ïãù ÏãúÍ∞Ñ (Î∂Ñ)</label>
                                <span id="val-break-${this.id}">${this.breakTime}</span>
                                <input type="range" id="input-break-${this.id}" min="1" max="10" value="${this.breakTime}">
                            </div>
                            <div class="control-group">
                                <label>Ï¥ù ÏÇ¨Ïù¥ÌÅ¥ Ïàò</label>
                                <span id="val-cycle-${this.id}">${this.totalCycles}</span>
                                <input type="range" id="input-cycle-${this.id}" min="1" max="20" value="${this.totalCycles}">
                            </div>
                            <div class="toggle-wrapper">
                                <span>ÏûêÎèô ÏßÑÌñâ</span> 
                                <input type="checkbox" id="check-auto-${this.id}" ${this.autoAdvance ? 'checked' : ''}>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            
            attachEvents() {
                const updateAndSave = (callback) => (e) => {
                    callback(e);
                    if (this.state === 'stopped' || e.type === 'change' || e.type === 'input') { 
                        saveSessionData();
                    }
                };
                
                document.getElementById(`card-${this.id}`).querySelector('.session-note').addEventListener('input', updateAndSave((e) => {
                    this.note = e.target.value;
                }));
                document.getElementById(`card-${this.id}`).querySelector('.session-name').addEventListener('input', updateAndSave((e) => {
                    this.name = e.target.value;
                }));
                
                document.getElementById(`input-focus-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.focusTime = parseInt(e.target.value);
                    document.getElementById(`val-focus-${this.id}`).innerText = this.focusTime;
                    if (this.state === 'stopped' && this.mode === 'focus') this.resetTimer();
                }));
                document.getElementById(`input-break-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.breakTime = parseInt(e.target.value);
                    document.getElementById(`val-break-${this.id}`).innerText = this.breakTime;
                    if (this.state === 'stopped' && this.mode === 'break') this.resetTimer();
                }));
                document.getElementById(`input-cycle-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.totalCycles = parseInt(e.target.value);
                    document.getElementById(`val-cycle-${this.id}`).innerText = this.totalCycles;
                    this.renderCycles();
                }));
                document.getElementById(`check-auto-${this.id}`).addEventListener('change', updateAndSave((e) => {
                    this.autoAdvance = e.target.checked;
                }));

                document.getElementById(`btn-start-${this.id}`).addEventListener('click', () => this.start());
                document.getElementById(`btn-pause-${this.id}`).addEventListener('click', () => this.pause());
                document.getElementById(`btn-reset-${this.id}`).addEventListener('click', () => this.resetTimer());
                document.getElementById(`btn-pass-${this.id}`).addEventListener('click', () => this.skipPhase());
            }

            renderCycles() {
                const container = document.getElementById(`cycle-visuals-${this.id}`);
                let html = '';
                const total = this.totalCycles;
                let firstRow, secondRow;

                if (total <= 10) {
                    firstRow = total;
                    secondRow = 0;
                } else {
                    firstRow = Math.ceil(total / 2);
                    secondRow = total - firstRow;
                }

                for (let i = 1; i <= total; i++) {
                    const isCurrent = i === this.currentCycle;
                    const isCompleted = i < this.currentCycle;
                    
                    if (i === firstRow + 1 && secondRow > 0) {
                         html += '<div style="width: 100%; height: 0; margin-bottom: -5px;"></div>';
                    }

                    if (isCompleted) {
                        html += '<span class="cycle-dot completed">‚óè</span>'; 
                    } else if (isCurrent) {
                        html += `<span class="cycle-dot current">‚óâ</span>`;
                    } else {
                        html += '<span class="cycle-dot future">‚óã</span>'; 
                    }
                }
                container.innerHTML = html;
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const display = document.getElementById(`timer-${this.id}`);
                
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = document.getElementById(`progress-${this.id}`);
                const percent = (this.timeLeft / this.initialTime) * 100;
                progress.style.width = `${percent}%`;

                const card = document.getElementById(`card-${this.id}`);
                if (this.mode === 'focus') {
                    display.classList.remove('break-mode');
                    progress.style.backgroundColor = 'var(--focus-color)';
                    card.style.borderTopColor = 'var(--focus-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--focus-color)');
                } else {
                    display.classList.add('break-mode');
                    progress.style.backgroundColor = 'var(--break-color)';
                    card.style.borderTopColor = 'var(--break-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--break-color)');
                }
            }

            updateStatus(msg) {
                document.getElementById(`status-${this.id}`).innerText = msg;
            }

            start() {
                if (this.state === 'running') return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                this.state = 'running';
                document.getElementById(`btn-start-${this.id}`).style.display = 'none';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'block';
                this.toggleInputs(true);
                this.updateStatus(this.mode === 'focus' ? 'üî• ÏßëÏ§ë Ï§ë...' : '‚òï Ìú¥Ïãù Ï§ë...');
                this.renderCycles();
                this.timerInterval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        this.updateDisplay();
                    } else {
                        this.completePhase();
                    }
                }, 1000);
            }

            pause() {
                if (this.state !== 'running') return;
                clearInterval(this.timerInterval);
                this.state = 'paused';
                document.getElementById(`btn-start-${this.id}`).innerText = 'Ïû¨Í∞ú';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.updateStatus('‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ');
            }

            skipPhase() {
                clearInterval(this.timerInterval);
                this.completePhase(true);
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.state = 'stopped';
                this.mode = 'focus';
                this.currentCycle = 1;
                this.timeLeft = this.focusTime * 60;
                this.initialTime = this.timeLeft;
                document.getElementById(`btn-start-${this.id}`).innerText = 'ÏãúÏûë';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.toggleInputs(false);
                this.updateStatus('Ready');
                this.renderCycles();
                this.updateDisplay();
                saveSessionData();
            }

            completePhase(mute = false) {
                clearInterval(this.timerInterval);
                if (!mute) playAlarm(); 

                if (this.mode === 'focus') {
                    this.mode = 'break';
                    this.timeLeft = this.breakTime * 60;
                    this.initialTime = this.timeLeft;
                    this.updateStatus('‚òï Ìú¥Ïãù Ï§ÄÎπÑ');
                } else {
                    if (this.currentCycle < this.totalCycles) {
                        this.mode = 'focus';
                        this.currentCycle++;
                        this.timeLeft = this.focusTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateStatus('üî• ÏßëÏ§ë Ï§ÄÎπÑ');
                    } else {
                        this.resetTimer();
                        this.updateStatus('üéâ Ï†ÑÏ≤¥ ÏôÑÎ£å!');
                        if(!mute) playAlarm(); 
                        return;
                    }
                }
                this.renderCycles();
                this.updateDisplay();
                if (this.autoAdvance) {
                    this.state = 'stopped';
                    this.start();
                } else {
                    this.state = 'stopped';
                    document.getElementById(`btn-start-${this.id}`).innerText = 'Îã§Ïùå Îã®Í≥Ñ ÏãúÏûë';
                    document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                    document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                    this.toggleInputs(false);
                }
            }

            toggleInputs(disabled) {
                document.getElementById(`input-focus-${this.id}`).disabled = disabled;
                document.getElementById(`input-break-${this.id}`).disabled = disabled;
                document.getElementById(`input-cycle-${this.id}`).disabled = disabled;
                document.getElementById(`check-auto-${this.id}`).disabled = disabled;
            }
        }


        // ===================================
        // ‚öôÔ∏è GLOBAL CONTROLLER LOGIC
        // ===================================
        
        const getSettingsCardHTML = () => {
            const currentVolume = Math.round(globalVolume * 100);
            const softSelected = alarmProfile === 'soft' ? 'class="selected"' : '';
            const mediumSelected = alarmProfile === 'medium' ? 'class="selected"' : '';
            const loudSelected = alarmProfile === 'loud' ? 'class="selected"' : '';
            
            return `
                <div class="session-card" id="settings-card">
                    <div class="card-header">
                        <input type="text" class="session-name" value="Setting" disabled/>
                    </div>
                    
                    <div class="status-badge" style="color: var(--setting-color);">ÎåÄÏãúÎ≥¥Îìú Í¥ÄÎ¶¨</div>
                    <div class="cycle-visuals" style="margin-bottom: 20px;"></div>

                    <div class="timer-display" style="font-size: 2rem; color: var(--setting-color); margin-top: 10px;">‚öôÔ∏è</div>
                    
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: 100%; background: #ddd;"></div>
                        </div>
                    </div>

                    <div class="controls" style="gap: 20px;">
                        <div class="control-group">
                            <label>Ïö¥ÏòÅÌï† ÌÉÄÏù¥Î®∏ Í∞úÏàò (1~10)</label>
                            <span id="session-count-value">${sessionCount}</span>
                            <input type="range" id="session-count-slider" min="1" max="10" value="${sessionCount}">
                        </div>

                        <div class="control-group">
                            <label>ÏïåÎûå Î≥ºÎ•®</label>
                            <span id="alarm-volume-value">${currentVolume}%</span>
                            <input type="range" id="alarm-volume-slider" min="0" max="100" value="${currentVolume}">
                        </div>
                        
                        <div style="grid-column: 1 / 3;">
                            <label style="font-size: 0.9rem; color: var(--gray-text);">ÏïåÎûå Ï¢ÖÎ•ò ÏÑ†ÌÉù</label>
                            <div class="alarm-selector">
                                <button id="alarm-soft" data-profile="soft" ${softSelected}>ÏûëÏùÄ ÏÜåÎ¶¨ üîà</button>
                                <button id="alarm-medium" data-profile="medium" ${mediumSelected}>Ï§ëÍ∞Ñ ÏÜåÎ¶¨ üîî</button>
                                <button id="alarm-loud" data-profile="loud" ${loudSelected}>ÌÅ∞ ÏÜåÎ¶¨ üîä</button>
                            </div>
                        </div>
                        
                        <div class="toggle-wrapper" style="margin-top: 5px; padding-top: 10px; border-top: 1px solid var(--input-border);">
                            <span>Îã§ÌÅ¨ Î™®Îìú</span>
                            <input type="checkbox" id="dark-mode-toggle" ${isDarkMode ? 'checked' : ''}>
                        </div>
                    </div>

                    <div class="notes-wrapper">
                        <input type="text" class="session-note" id="setting-note-1" placeholder="Î©îÎ™® 1" value="${settingNote1}">
                        <input type="text" class="session-note" id="setting-note-2" placeholder="Î©îÎ™® 2" value="${settingNote2}">
                        <input type="text" class="session-note" id="setting-note-3" placeholder="Î©îÎ™® 3" value="${settingNote3}">
                        <input type="text" class="session-note" id="setting-note-4" placeholder="Î©îÎ™® 4" value="${settingNote4}">
                    </div>
                    
                    <div class="action-buttons full-width" style="margin-top: 20px;">
                        <button id="alarm-test" style="background-color: var(--setting-color); color: white;" class="full-width">ÌÖåÏä§Ìä∏ ÏïåÎûå Ïû¨ÏÉù</button>
                    </div>
                </div>
            `;
        };

        function attachGlobalListeners() {
            const countSlider = document.getElementById('session-count-slider');
            const countValue = document.getElementById('session-count-value');

            if (!countSlider) return; 

            countSlider.oninput = (e) => {
                countValue.innerText = e.target.value; 
            };
            
            countSlider.onchange = (e) => {
                sessionCount = parseInt(e.target.value);
                saveGlobalSettings();
                createSessions(); 
            }

            const volumeSlider = document.getElementById('alarm-volume-slider');
            const volumeValue = document.getElementById('alarm-volume-value');
            
            volumeSlider.oninput = (e) => {
                globalVolume = parseInt(e.target.value) / 100;
                volumeValue.innerText = `${e.target.value}%`;
                saveGlobalSettings();
            };
            
            document.querySelectorAll('#settings-card .alarm-selector button[data-profile]').forEach(button => {
                button.onclick = (e) => {
                    alarmProfile = e.target.dataset.profile;
                    document.querySelectorAll('#settings-card .alarm-selector button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    saveGlobalSettings();
                };
            });

            document.getElementById('alarm-test').onclick = playAlarm;
            
            document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                toggleDarkMode(e.target.checked);
            });
            
            // Notes listeners are now slightly adjusted due to new wrapper
            document.getElementById('setting-note-1').addEventListener('input', (e) => {
                settingNote1 = e.target.value;
                saveGlobalSettings();
            });
            document.getElementById('setting-note-2').addEventListener('input', (e) => {
                settingNote2 = e.target.value;
                saveGlobalSettings();
            });
            document.getElementById('setting-note-3').addEventListener('input', (e) => {
                settingNote3 = e.target.value;
                saveGlobalSettings();
            });
            document.getElementById('setting-note-4').addEventListener('input', (e) => {
                settingNote4 = e.target.value;
                saveGlobalSettings();
            });
        }

        function createSessions() {
            activeSessions.forEach(session => {
                clearInterval(session.timerInterval);
            });
            activeSessions = [];
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = ''; 

            const loadedSessions = loadSessionData();
            
            for(let i=1; i<=sessionCount; i++) {
                const loadedData = loadedSessions.find(s => s.id === i) || {};
                const name = defaultNames[i-1] || `ÏÑ∏ÏÖò ${i}`;
                
                const newSession = new PomodoroSession(i, name, loadedData);
                activeSessions.push(newSession);
            }
            
            dashboard.insertAdjacentHTML('beforeend', getSettingsCardHTML());
            
            attachGlobalListeners(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalSettings(); 
            toggleDarkMode(isDarkMode); 
            if (audioCtx.state === 'suspended') {
                const resumeAudio = () => {
                    audioCtx.resume();
                    document.body.removeEventListener('touchstart', resumeAudio);
                    document.body.removeEventListener('mousedown', resumeAudio);
                };
                document.body.addEventListener('touchstart', resumeAudio, { once: true });
                document.body.addEventListener('mousedown', resumeAudio, { once: true });
            }
            createSessions(); 
        });

    </script>
</body>
</html>
