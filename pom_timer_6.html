<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pomodoro</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --focus-color: #ff6b6b;
            --break-color: #4ecdc4;
            --skip-color: #a29bfe;
            --setting-color: #00b894;
            --text-color: #333;
            --gray-text: #666;
            --shadow: 0 4px 10px rgba(0,0,0,0.1);
            --black-bar: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px 10px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 { 
            margin-bottom: 10px; 
            font-weight: 800; 
            color: var(--focus-color); 
            font-size: 2.5rem;
        }

        /* --- Dashboard Layout --- */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1600px;
        }

        /* Session Card íŒ¨ë”© ë° ìµœì†Œ ë†’ì´ ì¡°ì • */
        .session-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px; 
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            border-top: 6px solid var(--focus-color);
            position: relative;
            min-height: 450px; /* ë©”ëª¨ ì¶”ê°€ë¡œ ìµœì†Œ ë†’ì´ ì•½ê°„ ì¦ê°€ */
        }

        .session-name { 
            font-size: 1.1rem; 
            font-weight: bold; 
            border: none; 
            border-bottom: 1px solid #ddd; 
            width: 100%; 
            padding: 5px 0; /* ë©”ëª¨ í•„ë“œì™€ ê°„ê²© ì¡°ì ˆ */
            outline: none; 
            color: #2d3436; 
        }
        
        /* ë©”ëª¨ í•„ë“œ ìŠ¤íƒ€ì¼ */
        .session-note { 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            border: none; 
            border-bottom: 1px solid #eee;
            width: 100%; 
            padding: 5px 0; 
            margin-bottom: 5px; /* ìƒíƒœ ë°°ì§€ì™€ì˜ ê°„ê²© ì¡°ì ˆ */
            outline: none;
        }

        /* Status Badge ë§ˆì§„ ê°ì†Œ */
        .status-badge { 
            text-align: center; 
            font-size: 0.85rem; 
            margin-bottom: 3px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            min-height: 1.2em; 
        }
        
        /* Cycle Visuals ë§ˆì§„ ì¡°ì • */
        .cycle-visuals { 
            display: flex; 
            flex-wrap: wrap;
            justify-content: center; 
            gap: 5px; 
            margin: 5px 0 10px 0; 
            font-size: 1.2rem; 
            height: 35px;
            align-content: flex-start;
        }
        
        .cycle-dot {
            text-shadow: 0 0 1px var(--black-bar), 0 0 1px var(--black-bar);
        }
        .cycle-dot.completed { color: var(--gray-text); }
        .cycle-dot.current { color: var(--focus-color); animation: pulse 2s infinite; }
        .cycle-dot.future { color: #dfe6e9; }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* ìƒˆë¡œìš´ íƒ€ì´ë¨¸ wrapper */
        .timer-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }
        
        /* ì´ ì†Œìš” ì‹œê°„ ë””ìŠ¤í”Œë ˆì´ (íƒ€ì´ë¨¸ ìœ„ë¡œ ì´ë™) */
        .total-time-display {
            font-size: 0.8rem; 
            color: var(--gray-text); 
            font-weight: 500;
            text-align: center;
            margin-bottom: -5px; /* íƒ€ì´ë¨¸ì™€ ê°€ê¹ê²Œ */
            line-height: 1;
            padding-top: 5px;
        }

        /* Timer Display í°íŠ¸ ë° ë§ˆì§„ ê°ì†Œ */
        .timer-display { 
            font-size: 2.8rem; 
            font-weight: 800; 
            text-align: center; 
            margin: 0; 
            font-variant-numeric: tabular-nums; 
            color: var(--focus-color); 
            transition: color 0.3s; 
            line-height: 1.2;
        }
        .timer-display.break-mode { color: var(--break-color); }
        
        /* Progress Bar ë§ˆì§„ ê°ì†Œ */
        .progress-container { 
            margin-bottom: 10px; 
            height: 6px; 
            width: 100%;
            overflow: hidden;
        }
        .progress-bar-bg { 
            position: relative;
            width: 100%; 
            height: 6px; 
            background: var(--black-bar);
            border-radius: 3px;
        }
        .progress-bar-fill { 
            height: 100%; 
            background: var(--focus-color); 
            width: 100%; 
            transition: width 1s linear, background-color 0.3s; 
            border-radius: 3px;
            transform-origin: right; 
        }

        /* Buttons íŒ¨ë”© ë° ê°„ê²© ê°ì†Œ */
        .action-buttons { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 6px; 
            margin-top: 5px; 
            margin-bottom: 10px; 
        }
        .full-width { grid-column: span 2; }
        button { 
            padding: 8px; 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: opacity 0.2s; 
            font-size: 0.9rem; 
        }
        button:hover { opacity: 0.9; }
        .btn-start { background-color: var(--focus-color); color: white; }
        .btn-pause { background-color: #f1c40f; color: white; display: none; }
        .btn-pass { background-color: var(--skip-color); color: white; }
        .btn-reset { background-color: #95a5a6; color: white; }


        /* Controls íŒ¨ë”© ë° ë§ˆì§„ ê°ì†Œ */
        .controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            margin-bottom: 0px; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 8px; 
            margin-top: auto; 
        }
        .control-group { 
            display: grid; 
            grid-template-columns: 1fr auto; 
            align-items: center; 
            gap: 8px; 
        }
        .control-group label { 
            grid-column: 1 / 2;
            font-size: 0.9rem; 
            color: var(--gray-text); 
            justify-self: start;
        }
        .control-group span { 
            grid-column: 2 / 3;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
            width: 30px;
            text-align: right;
        }
        input[type=range] { 
            grid-column: 1 / 3;
            width: 100%; 
            cursor: pointer; 
            accent-color: var(--focus-color); 
            margin-top: 3px; 
        }
        
        .toggle-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            font-size: 0.9rem; 
            color: var(--gray-text); 
            margin-top: 5px; 
            padding-top: 5px;
            border-top: 1px solid #eee;
        }

        
        .alarm-selector { display: flex; gap: 5px; margin-top: 10px; }
        .alarm-selector button { flex: 1; font-size: 0.8rem; padding: 6px; border: 1px solid #ddd; background: #fff; }
        .alarm-selector button.selected { background: var(--setting-color); color: white; border-color: var(--setting-color); }
    </style>
</head>
<body>

    <h1>Pomodoro</h1>

    <div class="dashboard" id="dashboard">
    </div>

    <script>
        // --- Global State & Configuration ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let activeSessions = [];
        let globalVolume = 0.5;
        let alarmProfile = 'medium';
        let sessionCount = 5;
        const defaultNames = ['ê¸°íš', 'ê°œë°œ', 'ë””ìì¸', 'ë¬¸ì„œí™”', 'íšŒì˜', 'í•™ìŠµ', 'ìš´ë™', 'ì •ë¦¬', 'ë…ì„œ', 'ê¸°íƒ€'];

        // ===================================
        // ğŸ’¾ LOCAL STORAGE FUNCTIONS
        // ===================================

        function saveGlobalSettings() {
            const settings = {
                sessionCount: sessionCount,
                globalVolume: globalVolume,
                alarmProfile: alarmProfile
            };
            try {
                localStorage.setItem('pomodoroGlobalSettings', JSON.stringify(settings));
            } catch (e) {
                console.error("Local storage error during global save:", e);
            }
        }

        function loadGlobalSettings() {
            try {
                const data = localStorage.getItem('pomodoroGlobalSettings');
                if (data) {
                    const settings = JSON.parse(data);
                    sessionCount = settings.sessionCount || 5;
                    globalVolume = settings.globalVolume !== undefined ? settings.globalVolume : 0.5;
                    alarmProfile = settings.alarmProfile || 'medium';
                }
            } catch (e) {
                console.error("Local storage error during global load:", e);
            }
        }

        function saveSessionData() {
            const sessionData = activeSessions.map(session => ({
                id: session.id,
                name: session.name,
                note: session.note, /* ë©”ëª¨ í•„ë“œ ë°ì´í„° ì €ì¥ */
                focusTime: session.focusTime,
                breakTime: session.breakTime,
                totalCycles: session.totalCycles,
                autoAdvance: session.autoAdvance
            }));
            try {
                localStorage.setItem('pomodoroSessionData', JSON.stringify(sessionData));
            } catch (e) {
                console.error("Local storage error during session save:", e);
            }
        }

        function loadSessionData() {
            try {
                const data = localStorage.getItem('pomodoroSessionData');
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Local storage error during session load:", e);
                return [];
            }
        }
        
        // ===================================
        // â²ï¸ TIME UTILITY FUNCTIONS
        // ===================================
        function formatTotalTime(totalMinutes) {
            if (totalMinutes <= 0) {
                return 'ì´ 0ì‹œê°„ 00ë¶„';
            }
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (hours > 0) {
                return `ì´ ${hours}ì‹œê°„ ${String(minutes).padStart(2, '0')}ë¶„`;
            } else {
                return `ì´ ${String(minutes).padStart(2, '0')}ë¶„`;
            }
        }


        // ===================================
        // ğŸ”Š ALARM SOUND FUNCTIONS
        // ===================================

        const createBeep = (startTime, duration, freq, type, vol) => {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.type = type;
            oscillator.frequency.value = freq;
            gainNode.gain.setValueAtTime(vol, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        };
        
        // ë²„íŠ¼ ì¡°ì‘ ì‹œ ì•Œë¦¼ìŒ (ê³ ì •ëœ ì‘ì€ ì†Œë¦¬)
        function playNotificationSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            // 'soft' ì•ŒëŒê³¼ ìœ ì‚¬, ê³ ì •ëœ ë³¼ë¥¨(0.15) ì ìš©
            createBeep(now, 0.1, 440, 'sine', 0.15); 
        }


        function playAlarm() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            // ì „ì—­ ë³¼ë¥¨ì´ ì ìš©ëœ í¬ê¸°ë¡œ ì¬ìƒ
            const vol = Math.max(0.01, 1.0 * globalVolume);

            switch(alarmProfile) {
                case 'soft':
                    createBeep(now, 0.2, 440, 'sine', 0.2 * vol); 
                    break;
                case 'medium':
                    createBeep(now, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.15, 0.1, 880, 'square', 0.5 * vol);
                    createBeep(now + 0.3, 0.3, 1100, 'square', 0.5 * vol);
                    break;
                case 'loud':
                    createBeep(now, 0.5, 1200, 'sawtooth', 1.0 * vol); 
                    break;
            }
        }

        // ===================================
        // â±ï¸ POMODORO SESSION CLASS
        // ===================================

        class PomodoroSession {
            constructor(id, defaultName, loadedData = {}) {
                this.id = id;
                this.name = loadedData.name || defaultName || `Session ${id}`;
                this.note = loadedData.note || ''; /* ë©”ëª¨ í•„ë“œ ì´ˆê¸°í™” */
                this.state = 'stopped'; 
                this.mode = 'focus'; 
                this.currentCycle = 1;
                this.totalCycles = loadedData.totalCycles || 4;
                this.focusTime = loadedData.focusTime || 25; 
                this.breakTime = loadedData.breakTime || 5;  
                this.autoAdvance = loadedData.autoAdvance || false;
                
                this.timeLeft = this.focusTime * 60;
                this.timerInterval = null;
                this.initialTime = this.focusTime * 60;

                this.render();
                this.attachEvents();
                this.updateDisplay();
                this.renderCycles(); 
                this.updateTotalTimeDisplay(); 
            }
            
            calculateTotalTime() {
                // (ì§‘ì¤‘ ì‹œê°„ * ì´ ì‚¬ì´í´ ìˆ˜) + (íœ´ì‹ ì‹œê°„ * (ì´ ì‚¬ì´í´ ìˆ˜ - 1))
                const totalMinutes = (this.focusTime * this.totalCycles) + (this.breakTime * (this.totalCycles > 0 ? this.totalCycles - 1 : 0));
                return totalMinutes;
            }

            updateTotalTimeDisplay() {
                const totalMinutes = this.calculateTotalTime();
                const formattedTime = formatTotalTime(totalMinutes);
                
                const element = document.getElementById(`total-time-${this.id}`);
                if (element) {
                    element.innerText = formattedTime;
                }
            }


            // RENDER ë©”ì„œë“œ: session-note ë³µêµ¬, timer-wrapper ìˆœì„œ ë³€ê²½
            render() {
                const container = document.getElementById('dashboard');
                const html = `
                    <div class="session-card" id="card-${this.id}">
                        <div class="card-header">
                            <input type="text" class="session-name" value="${this.name}">
                            <input type="text" class="session-note" placeholder="ê°„ë‹¨í•œ ë©”ëª¨ (ì˜ˆ: ì§‘ì¤‘ ëª©í‘œ)" value="${this.note}">
                        </div>
                        
                        <div class="status-badge" id="status-${this.id}">Ready</div>
                        <div class="cycle-visuals" id="cycle-visuals-${this.id}"></div>
                        
                        <div class="timer-wrapper">
                            <div class="total-time-display" id="total-time-${this.id}"></div> <div class="timer-display" id="timer-${this.id}">${(this.focusTime).toString().padStart(2, '0')}:00</div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" id="progress-${this.id}"></div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-start full-width" id="btn-start-${this.id}">ì‹œì‘</button>
                            <button class="btn-pause full-width" id="btn-pause-${this.id}">ì¼ì‹œì •ì§€</button>
                            
                            <button class="btn-pass" id="btn-pass-${this.id}">PASS â­ï¸</button>
                            <button class="btn-reset" id="btn-reset-${this.id}">ë¦¬ì…‹ â†º</button>
                        </div>
                        
                        <div class="controls">
                            <div class="control-group">
                                <label>ì§‘ì¤‘ ì‹œê°„ (ë¶„)</label>
                                <span id="val-focus-${this.id}">${this.focusTime}</span>
                                <input type="range" id="input-focus-${this.id}" min="1" max="60" value="${this.focusTime}">
                            </div>
                            <div class="control-group">
                                <label>íœ´ì‹ ì‹œê°„ (ë¶„)</label>
                                <span id="val-break-${this.id}">${this.breakTime}</span>
                                <input type="range" id="input-break-${this.id}" min="1" max="10" value="${this.breakTime}">
                            </div>
                            <div class="control-group">
                                <label>ì´ ì‚¬ì´í´ ìˆ˜</label>
                                <span id="val-cycle-${this.id}">${this.totalCycles}</span>
                                <input type="range" id="input-cycle-${this.id}" min="1" max="20" value="${this.totalCycles}">
                            </div>
                            <div class="toggle-wrapper">
                                <span>ìë™ ì§„í–‰ (Auto Advance)</span>
                                <input type="checkbox" id="check-auto-${this.id}" ${this.autoAdvance ? 'checked' : ''}>
                            </div>
                        </div>

                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            }
            
            attachEvents() {
                const updateAndSave = (callback) => (e) => {
                    callback(e);
                    if (['input-focus', 'input-break', 'input-cycle'].some(idPart => e.target.id.includes(idPart))) {
                        this.updateTotalTimeDisplay();
                        playNotificationSound(); 
                    }
                    if (this.state === 'stopped' || e.type === 'change' || e.type === 'input') { 
                        saveSessionData();
                    }
                };
                
                /* ë©”ëª¨ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë³µêµ¬ */
                document.getElementById(`card-${this.id}`).querySelector('.session-note').addEventListener('input', updateAndSave((e) => {
                    this.note = e.target.value;
                }));
                
                document.getElementById(`card-${this.id}`).querySelector('.session-name').addEventListener('input', updateAndSave((e) => {
                    this.name = e.target.value;
                }));
                
                document.getElementById(`input-focus-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.focusTime = parseInt(e.target.value);
                    document.getElementById(`val-focus-${this.id}`).innerText = this.focusTime;
                    if (this.state === 'stopped' && this.mode === 'focus') this.resetTimer();
                }));
                document.getElementById(`input-break-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.breakTime = parseInt(e.target.value);
                    document.getElementById(`val-break-${this.id}`).innerText = this.breakTime;
                    if (this.state === 'stopped' && this.mode === 'break') this.resetTimer();
                }));
                document.getElementById(`input-cycle-${this.id}`).addEventListener('input', updateAndSave((e) => {
                    this.totalCycles = parseInt(e.target.value);
                    document.getElementById(`val-cycle-${this.id}`).innerText = this.totalCycles;
                    this.renderCycles();
                }));
                document.getElementById(`check-auto-${this.id}`).addEventListener('change', updateAndSave((e) => {
                    this.autoAdvance = e.target.checked;
                }));

                // ë²„íŠ¼ ì´ë²¤íŠ¸ì— ì•Œë¦¼ìŒ ì¶”ê°€ (ìœ ì§€)
                document.getElementById(`btn-start-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.start();
                });
                document.getElementById(`btn-pause-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.pause();
                });
                document.getElementById(`btn-reset-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.resetTimer();
                });
                document.getElementById(`btn-pass-${this.id}`).addEventListener('click', () => { 
                    playNotificationSound(); 
                    this.skipPhase();
                });
            }

            
            renderCycles() {
                const container = document.getElementById(`cycle-visuals-${this.id}`);
                let html = '';
                const total = this.totalCycles;
                let firstRow, secondRow;

                if (total <= 9) {
                    firstRow = total;
                    secondRow = 0;
                } else {
                    firstRow = Math.min(10, Math.ceil(total / 2)); 
                    secondRow = total - firstRow;
                }

                for (let i = 1; i <= total; i++) {
                    const isCurrent = i === this.currentCycle;
                    const isCompleted = i < this.currentCycle;
                    
                    if (i === firstRow + 1 && secondRow > 0) {
                         html += '<div style="width: 100%; height: 0; margin-bottom: -5px;"></div>';
                    }

                    if (isCompleted) {
                        html += '<span class="cycle-dot completed">â—</span>'; 
                    } else if (isCurrent) {
                        html += `<span class="cycle-dot current">â—‰</span>`;
                    } else {
                        html += '<span class="cycle-dot future">â—‹</span>'; 
                    }
                }
                container.innerHTML = html;
            }

            updateDisplay() {
                const minutes = Math.floor(this.timeLeft / 60);
                const seconds = this.timeLeft % 60;
                const display = document.getElementById(`timer-${this.id}`);
                
                display.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                const progress = document.getElementById(`progress-${this.id}`);
                const percent = (this.timeLeft / this.initialTime) * 100;
                progress.style.width = `${percent}%`;

                const card = document.getElementById(`card-${this.id}`);
                if (this.mode === 'focus') {
                    display.classList.remove('break-mode');
                    progress.style.backgroundColor = 'var(--focus-color)';
                    card.style.borderTopColor = 'var(--focus-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--focus-color)');
                } else {
                    display.classList.add('break-mode');
                    progress.style.backgroundColor = 'var(--break-color)';
                    card.style.borderTopColor = 'var(--break-color)';
                    document.querySelectorAll(`#cycle-visuals-${this.id} .current`).forEach(el => el.style.color = 'var(--break-color)');
                }
            }

            updateStatus(msg) {
                document.getElementById(`status-${this.id}`).innerText = msg;
            }

            start() {
                if (this.state === 'running') return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                this.state = 'running';
                document.getElementById(`btn-start-${this.id}`).style.display = 'none';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'block';
                this.toggleInputs(true);
                this.updateStatus(this.mode === 'focus' ? 'ğŸ”¥ ì§‘ì¤‘ ì¤‘...' : 'â˜• íœ´ì‹ ì¤‘...');
                this.renderCycles();
                this.timerInterval = setInterval(() => {
                    if (this.timeLeft > 0) {
                        this.timeLeft--;
                        this.updateDisplay();
                    } else {
                        this.completePhase();
                    }
                }, 1000);
            }

            pause() {
                if (this.state !== 'running') return;
                clearInterval(this.timerInterval);
                this.state = 'paused';
                document.getElementById(`btn-start-${this.id}`).innerText = 'ì¬ê°œ';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.updateStatus('â¸ï¸ ì¼ì‹œì •ì§€');
            }

            skipPhase() {
                clearInterval(this.timerInterval);
                this.completePhase(true);
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.state = 'stopped';
                this.mode = 'focus';
                this.currentCycle = 1;
                this.timeLeft = this.focusTime * 60;
                this.initialTime = this.timeLeft;
                document.getElementById(`btn-start-${this.id}`).innerText = 'ì‹œì‘';
                document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                this.toggleInputs(false);
                this.updateStatus('Ready');
                this.renderCycles();
                this.updateDisplay();
                saveSessionData();
            }

            completePhase(mute = false) {
                clearInterval(this.timerInterval);
                if (!mute) playAlarm(); 

                if (this.mode === 'focus') {
                    this.mode = 'break';
                    this.timeLeft = this.breakTime * 60;
                    this.initialTime = this.timeLeft;
                    this.updateStatus('â˜• íœ´ì‹ ì¤€ë¹„');
                } else {
                    if (this.currentCycle < this.totalCycles) {
                        this.mode = 'focus';
                        this.currentCycle++;
                        this.timeLeft = this.focusTime * 60;
                        this.initialTime = this.timeLeft;
                        this.updateStatus('ğŸ”¥ ì§‘ì¤‘ ì¤€ë¹„');
                    } else {
                        this.resetTimer();
                        this.updateStatus('ğŸ‰ ì „ì²´ ì™„ë£Œ!');
                        if(!mute) playAlarm(); 
                        return;
                    }
                }
                this.renderCycles();
                this.updateDisplay();
                if (this.autoAdvance) {
                    this.state = 'stopped';
                    this.start();
                } else {
                    this.state = 'stopped';
                    document.getElementById(`btn-start-${this.id}`).innerText = 'ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘';
                    document.getElementById(`btn-start-${this.id}`).style.display = 'block';
                    document.getElementById(`btn-pause-${this.id}`).style.display = 'none';
                    this.toggleInputs(false);
                }
            }

            toggleInputs(disabled) {
                document.getElementById(`input-focus-${this.id}`).disabled = disabled;
                document.getElementById(`input-break-${this.id}`).disabled = disabled;
                document.getElementById(`input-cycle-${this.id}`).disabled = disabled;
                document.getElementById(`check-auto-${this.id}`).disabled = disabled;
            }
        }


        // ===================================
        // âš™ï¸ GLOBAL CONTROLLER LOGIC
        // ===================================
        
        const getSettingsCardHTML = () => {
            const currentVolume = Math.round(globalVolume * 100);
            const softSelected = alarmProfile === 'soft' ? 'class="selected"' : '';
            const mediumSelected = alarmProfile === 'medium' ? 'class="selected"' : '';
            const loudSelected = alarmProfile === 'loud' ? 'class="selected"' : '';
            
            return `
                <div class="session-card" id="settings-card">
                    <div class="card-header">
                        <input type="text" class="session-name" value="ì „ì—­ ì„¤ì • (Global Settings)" disabled/>
                        <input type="text" class="session-note" placeholder="ì„¤ì • ì¹´ë“œì—ì„œëŠ” ë©”ëª¨ ë¹„í™œì„±í™”" disabled>
                    </div>
                    
                    <div class="status-badge" style="color: var(--setting-color);">ëŒ€ì‹œë³´ë“œ ê´€ë¦¬</div>
                    <div class="cycle-visuals" style="margin-bottom: 20px;"></div>

                    <div class="timer-wrapper">
                        <div class="total-time-display" style="font-size: 0.9rem; margin-top: 0;">(íƒ€ì´ë¨¸ ê°œìˆ˜ ì¡°ì ˆ)</div>
                        <div class="timer-display" style="font-size: 2.5rem; color: var(--setting-color); margin-top: 5px;">âš™ï¸</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" style="width: 100%; background: #ddd;"></div>
                        </div>
                    </div>
                    
                    <div class="action-buttons full-width" style="margin-top: 5px; margin-bottom: 10px;">
                        <button id="alarm-test" style="background-color: var(--setting-color); color: white;" class="full-width">í…ŒìŠ¤íŠ¸ ì•ŒëŒ ì¬ìƒ</button>
                    </div>

                    <div class="controls" style="gap: 15px; margin-top: auto; margin-bottom: 0;">
                        <div class="control-group">
                            <label>ìš´ì˜í•  íƒ€ì´ë¨¸ ê°œìˆ˜ (1~10)</label>
                            <span id="session-count-value">${sessionCount}</span>
                            <input type="range" id="session-count-slider" min="1" max="10" value="${sessionCount}">
                        </div>

                        <div class="control-group">
                            <label>ì•ŒëŒ ë³¼ë¥¨</label>
                            <span id="alarm-volume-value">${currentVolume}%</span>
                            <input type="range" id="alarm-volume-slider" min="0" max="100" value="${currentVolume}">
                        </div>
                        
                        <div style="grid-column: 1 / 3;">
                            <label style="font-size: 0.9rem; color: var(--gray-text);">ì•ŒëŒ ì¢…ë¥˜ ì„ íƒ</label>
                            <div class="alarm-selector">
                                <button id="alarm-soft" data-profile="soft" ${softSelected}>ì‘ì€ ì†Œë¦¬ ğŸ”ˆ</button>
                                <button id="alarm-medium" data-profile="medium" ${mediumSelected}>ì¤‘ê°„ ì†Œë¦¬ ğŸ””</button>
                                <button id="alarm-loud" data-profile="loud" ${loudSelected}>í° ì†Œë¦¬ ğŸ”Š</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        function attachGlobalListeners() {
            const countSlider = document.getElementById('session-count-slider');
            const countValue = document.getElementById('session-count-value');

            if (!countSlider) return; 

            countSlider.oninput = (e) => {
                countValue.innerText = e.target.value; 
            };
            
            countSlider.onchange = (e) => {
                sessionCount = parseInt(e.target.value);
                playNotificationSound(); 
                saveGlobalSettings(); 
                createSessions(); 
            }

            const volumeSlider = document.getElementById('alarm-volume-slider');
            const volumeValue = document.getElementById('alarm-volume-value');
            
            volumeSlider.oninput = (e) => {
                globalVolume = parseInt(e.target.value) / 100;
                volumeValue.innerText = `${e.target.value}%`;
                saveGlobalSettings(); 
            };
            
            document.querySelectorAll('#settings-card .alarm-selector button[data-profile]').forEach(button => {
                button.onclick = (e) => {
                    alarmProfile = e.target.dataset.profile;
                    playNotificationSound(); 
                    document.querySelectorAll('#settings-card .alarm-selector button').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    saveGlobalSettings(); 
                };
            });

            document.getElementById('alarm-test').onclick = () => {
                playAlarm();
                playNotificationSound(); 
            }
        }

        function createSessions() {
            activeSessions.forEach(session => {
                clearInterval(session.timerInterval);
            });
            activeSessions = [];
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = ''; 

            const loadedSessions = loadSessionData();
            
            for(let i=1; i<=sessionCount; i++) {
                const loadedData = loadedSessions.find(s => s.id === i) || {};
                const name = defaultNames[i-1] || `ì„¸ì…˜ ${i}`;
                
                const newSession = new PomodoroSession(i, name, loadedData);
                activeSessions.push(newSession);
            }
            
            dashboard.insertAdjacentHTML('beforeend', getSettingsCardHTML());
            
            attachGlobalListeners(); 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalSettings(); 
            
            if (audioCtx.state === 'suspended') {
                const resumeAudio = () => {
                    audioCtx.resume();
                    document.body.removeEventListener('touchstart', resumeAudio);
                    document.body.removeEventListener('mousedown', resumeAudio);
                };
                document.body.addEventListener('touchstart', resumeAudio, { once: true });
                document.body.addEventListener('mousedown', resumeAudio, { once: true });
            }
            createSessions(); 
        });

    </script>
</body>
</html>
